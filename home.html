<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vital Signs Realtime Dashboard</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Load jQuery for sliding logic -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            background-color: #f3f4f6;
        }
        :root {
            --primary-color: #4f46e5;
            --primary-color700: #4338ca;
            --secondary-color100: #eef2ff;
            --black: #1f2937;
            --white: #ffffff;
        }

        /* Viewport Container */
        .cover3man {
            width: 100vw; 
            height: calc(100vh - 70px); 
            overflow: hidden;
            position: relative;
        }
        
        /* Sliding Main Div */
        .div-mainpage333 {
            display: flex;
            width: 300vw;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0; 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Individual Pages */
        .coveruserpage, .coverhomebooking, .covertotalbooking {
            width: 100vw;
            height: 100%;
            flex-shrink: 0;
            overflow: hidden; 
        }

        /* Animation States */
        .left1 { transform: translateX(0); }
        .center00 { transform: translateX(-100vw); }
        .right2 { transform: translateX(-200vw); }

        /* Fixed Bottom Menu Full Width */
        .bottom-nav-container {
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 50;
            height: 70px;
            display: flex;
            justify-content: center;
        }

        .covermenubot {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 100%;
            width: 100%;
            background-color: var(--white);
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }

        .sub-botmenu {
            cursor: pointer;
            width: 33.33%;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            position: relative;
            transition: all 0.2s;
        }

        .icon-size { width: 26px; height: 26px; } 

        /* Scroll Area - Full Width Content */
        .page-content-scroll {
            height: 100%; 
            overflow-y: auto; 
            padding-bottom: 2rem;
        }

        .content-wrapper {
            width: 100%;
            padding: 1rem;
        }
        
        @media (min-width: 768px) {
            .content-wrapper {
                padding: 2rem; 
            }
        }
        
        .chart-container {
            width: 100%;
            background: white;
            padding: 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .table-responsive-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 0.75rem;
        }

        /* Detail Box Styling */
        #point-detail-box {
            display: none;
            background: #ffffff;
            border-left: 6px solid #4f46e5;
            padding: 1.25rem;
            margin-top: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Metric Tabs Responsive */
        .metric-tab {
            cursor: pointer;
            padding: 0.6rem;
            font-size: 0.875rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            text-align: center;
            flex: 1;
        }
        .metric-tab.active {
            background-color: white;
            color: #4f46e5;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .picker-input {
            border: 1px solid #d1d5db;
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.2s;
            width: 100%;
        }
        .picker-input:focus {
            border-color: #4f46e5;
        }
        .filter-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    
    <!-- Viewport -->
    <div class="cover3man">
        <div id="mainpage333" class="div-mainpage333 center00">
            
            <!-- Page 1: User Profile -->
            <div id="user-page" class="coveruserpage page-content-scroll">
                <div class="content-wrapper">
                    <h2 class="text-3xl font-bold text-indigo-700 mb-8 mt-4 text-center">ผู้ใช้</h2>
                    
                    <div class="bg-white p-8 rounded-3xl shadow-xl flex flex-col items-center mb-8 border border-gray-100">
                        <div class="h-24 w-24 rounded-full bg-indigo-50 overflow-hidden border-4 border-white shadow-inner flex items-center justify-center">
                            <svg class="h-12 w-12 text-indigo-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-black text-gray-800 mt-4">Device ID: <span id="uid-display" class="text-indigo-600">device01</span></h3>
                        <p class="text-sm text-gray-400">สถานะ: ออนไลน์ (Online)</p>
                        
                        <button class="w-full mt-8 py-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-2xl shadow-lg shadow-red-100 transition duration-150">
                            ออกจากระบบ
                        </button>
                    </div>

                    <div id="auth-status" class="bg-indigo-900 text-white p-6 rounded-3xl shadow-lg">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="h-2 w-2 bg-green-400 rounded-full animate-pulse"></div>
                            <p class="text-sm font-bold">เชื่อมต่อ Firestore สำเร็จ</p>
                        </div>
                        <p class="text-xs text-indigo-200 font-mono opacity-80" id="path-display">--</p>
                    </div>
                </div>
            </div>
            
            <!-- Page 2: Home Metrics -->
            <div id="metrics-page" class="coverhomebooking page-content-scroll">
                 <div class="content-wrapper">
                    <!-- Title centered as requested -->
                    <h2 class="text-3xl font-black text-gray-800 mb-8 mt-4 text-center">สัญญาณชีพแบบเรียลไทม์</h2>
                    
                    <div id="latest-reading" class="text-center mb-8 p-6 bg-white rounded-3xl shadow-lg border border-indigo-50">
                        <p class="text-lg font-medium text-gray-400">รอรับข้อมูล...</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- HR Card - Label and Status on the same line -->
                        <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-xl border-b-8 border-red-500">
                            <div class="flex justify-between items-center mb-6">
                                <p class="text-xl font-black text-gray-800 uppercase tracking-widest">Heart Rate</p>
                                <span id="hr-status" class="text-[10px] font-bold px-3 py-1 rounded-full uppercase bg-gray-50 text-gray-400 whitespace-nowrap">Wait</span>
                            </div>
                            <div class="flex flex-col items-center py-2">
                                <div class="flex items-baseline gap-2">
                                    <span id="current-hr" class="text-7xl sm:text-8xl font-black text-gray-800 leading-none">--</span>
                                    <span class="text-gray-400 font-bold text-xl sm:text-2xl uppercase">bpm</span>
                                </div>
                            </div>
                        </div>

                        <!-- SpO2 Card - Label and Status on the same line -->
                        <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-xl border-b-8 border-blue-500">
                            <div class="flex justify-between items-center mb-6">
                                <p class="text-xl font-black text-gray-800 uppercase tracking-widest">Oxygen SpO₂</p>
                                <span id="spo2-status" class="text-[10px] font-bold px-3 py-1 rounded-full uppercase bg-gray-50 text-gray-400 whitespace-nowrap">Wait</span>
                            </div>
                            <div class="flex flex-col items-center py-2">
                                <div class="flex items-baseline gap-2">
                                    <span id="current-spo2" class="text-7xl sm:text-8xl font-black text-gray-800 leading-none">--</span>
                                    <span class="text-gray-400 font-bold text-xl sm:text-2xl">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Page 3: History & Charts -->
            <div id="history-page" class="covertotalbooking page-content-scroll">
                <div class="content-wrapper">
                    <h2 class="text-3xl font-black text-gray-800 mb-8 mt-4 text-center">History</h2>

                    <!-- Filter Section -->
                    <div class="bg-white p-6 rounded-3xl shadow-lg mb-8 grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="filter-label block">รายวัน</label>
                            <input type="date" id="date-picker" class="picker-input font-bold text-gray-700">
                        </div>
                        <div class="space-y-1">
                            <label class="filter-label block">รายเดือน</label>
                            <input type="month" id="month-picker" class="picker-input font-bold text-gray-700">
                        </div>
                    </div>

                    <!-- Chart Card -->
                    <div class="chart-container mb-8">
                        <div class="flex bg-gray-100 p-1.5 rounded-2xl gap-1 mb-6">
                            <div onclick="setMetricView('both')" id="tab-both" class="metric-tab active">ทั้งหมด</div>
                            <div onclick="setMetricView('hr')" id="tab-hr" class="metric-tab">HR</div>
                            <div onclick="setMetricView('spo2')" id="tab-spo2" class="metric-tab">SpO₂</div>
                        </div>

                        <div class="h-[300px] md:h-[400px]">
                            <canvas id="chart"></canvas>
                        </div>

                        <!-- Point Details -->
                        <div id="point-detail-box">
                            <div class="flex justify-between items-center">
                                <div class="flex-1">
                                    <p class="text-[10px] text-gray-400 font-bold uppercase mb-2">ข้อมูลที่เลือก</p>
                                    <p id="detail-date" class="text-sm text-indigo-800 font-black leading-tight">--</p>
                                    <p id="detail-time" class="text-xs text-gray-400 font-medium">--</p>
                                </div>
                                <div class="flex gap-6 border-l-2 pl-6 border-indigo-50">
                                    <div class="text-center">
                                        <p class="text-[10px] text-red-400 font-bold mb-1">HR</p>
                                        <p id="detail-hr" class="text-2xl text-gray-800 font-black">--</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-[10px] text-blue-400 font-bold mb-1">SpO₂</p>
                                        <p id="detail-spo2" class="text-2xl text-gray-800 font-black">--</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Table Card -->
                    <div class="bg-white p-6 rounded-3xl shadow-xl">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-black text-gray-800">ประวัติบันทึก</h3>
                            <div class="text-[10px] font-bold text-indigo-500 bg-indigo-50 px-3 py-1 rounded-full">
                                <span id="current-page-num">1</span> / <span id="total-pages-num">1</span>
                            </div>
                        </div>
                        
                        <div class="table-responsive-container">
                            <table class="min-w-full">
                                <thead class="sticky top-0 bg-gray-50 text-gray-400">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-[10px] font-bold uppercase tracking-widest">วัน / เวลา</th>
                                        <th class="px-4 py-3 text-left text-[10px] font-bold uppercase tracking-widest">HR</th>
                                        <th class="px-4 py-3 text-left text-[10px] font-bold uppercase tracking-widest">SpO₂</th>
                                    </tr>
                                </thead>
                                <tbody id="data-table-body" class="divide-y divide-gray-50 text-gray-700">
                                    <tr><td colspan="3" class="p-8 text-center text-sm text-gray-300">กำลังดาวน์โหลดข้อมูล...</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-8 flex justify-between gap-4">
                            <button id="prev-page" class="flex-1 py-3 bg-gray-100 hover:bg-indigo-600 hover:text-white rounded-2xl font-bold transition-all disabled:opacity-30">ก่อนหน้า</button>
                            <button id="next-page" class="flex-1 py-3 bg-gray-100 hover:bg-indigo-600 hover:text-white rounded-2xl font-bold transition-all disabled:opacity-30">ถัดไป</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav-container">
        <div id="menubottommain" class="covermenubot">
            <div onclick="testbto(1)" class="sub-botmenu group">
                <svg id="user-icon" class="icon-size text-gray-300 group-hover:text-indigo-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            </div>
            <div onclick="testbto(2)" class="sub-botmenu">
                <div id="center-icon-wrapper" class="h-14 w-14 rounded-2xl bg-indigo-600 flex items-center justify-center -mt-8 shadow-xl shadow-indigo-200 cursor-pointer transition-all transform hover:scale-110">
                    <svg class="h-8 w-8 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                </div>
            </div>
            <div onclick="testbto(3)" class="sub-botmenu group"> 
                <svg id="history-icon" class="icon-size text-gray-300 group-hover:text-indigo-600" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3h-2V1h-2v2H9V1H7v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zm-5-8H9c-.55 0-1 .45-1 1s.45 1 1 1h5c.55 0 1-.45 1-1s-.45-1-1-1z"/></svg>
            </div>
        </div>
    </div>
    
    <script>
        const mainpage = $('#mainpage333');
        const userIcon = $('#user-icon');
        const historyIcon = $('#history-icon');

        function testbto(id) {
            userIcon.removeClass('text-indigo-600').addClass('text-gray-300');
            historyIcon.removeClass('text-indigo-600').addClass('text-gray-300');
            $('#center-icon-wrapper').addClass('bg-indigo-600').removeClass('bg-red-500'); 

            if (id === 1) {
                mainpage.removeClass('center00 right2').addClass('left1');
                userIcon.removeClass('text-gray-300').addClass('text-indigo-600');
            } else if (id === 2) {
                mainpage.removeClass('left1 right2').addClass('center00');
                $('#center-icon-wrapper').removeClass('bg-indigo-600').addClass('bg-red-500');
            } else if (id === 3) {
                mainpage.removeClass('left1 center00').addClass('right2');
                historyIcon.removeClass('text-gray-300').addClass('text-indigo-600');
            }
        }

        window.setMetricView = function(view) {
            $('.metric-tab').removeClass('active');
            $(`#tab-${view}`).addClass('active');
            window.currentMetricView = view;
            if (window.updateChartView) window.updateChartView();
        }

        $(document).ready(() => testbto(2));
    </script>

    <script type="module">
        const USER_ID = "device01";
        const COLLECTION_PATH = `users/${USER_ID}/records`;
        const ROWS_PER_PAGE = 10;
        
        const firebaseConfig = {
            apiKey: "", 
            authDomain: "hrspo-98b0c.firebaseapp.com",
            projectId: "hrspo-98b0c",
            storageBucket: "hrspo-98b0c.firebasestorage.app",
            messagingSenderId: "364239224326",
            appId: "1:364239224326:web:1e66faddd8e6dd2e718d87",
            measurementId: "G-2PYKXDEDEH"
        };
        
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        let db;
        let chartInstance;
        
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayStr = `${yyyy}-${mm}-${dd}`;

        window.currentMetricView = 'both';
        let currentFilterMode = 'date'; 
        let selectedFilterValue = todayStr; 
        let chartRawObjects = []; 

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";

        function initializeChart() {
            const ctx = document.getElementById('chart').getContext("2d");
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: "Heart Rate", borderColor: "#EF4444", backgroundColor: "rgba(239, 68, 68, 0.1)", tension: 0.4, data: [], fill: false, borderWidth: 4, pointRadius: 4, pointHoverRadius: 8, pointBackgroundColor: "white" },
                        { label: "SpO2", borderColor: "#3B82F6", backgroundColor: "rgba(59, 130, 246, 0.1)", tension: 0.4, data: [], fill: false, borderWidth: 4, pointRadius: 4, pointHoverRadius: 8, pointBackgroundColor: "white" }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const data = chartRawObjects[index];
                            if (data) showPointDetail(data);
                        }
                    },
                    interaction: { mode: 'index', intersect: false },
                    scales: { 
                        y: { min: 40, max: 120, grid: { borderDash: [5, 5] } },
                        x: { grid: { display: false }, ticks: { maxTicksLimit: 12, font: { size: 10 } } }
                    },
                    plugins: { 
                        legend: { display: false },
                        tooltip: { 
                            enabled: true,
                            backgroundColor: 'rgba(31, 41, 55, 0.9)',
                            padding: 12,
                            cornerRadius: 12,
                            callbacks: {
                                title: (items) => chartRawObjects[items[0].dataIndex].timeLabel,
                                label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y} ${ctx.dataset.label.includes('Heart') ? 'bpm' : '%'}`
                            }
                        }
                    }
                }
            });
        }

        function showPointDetail(data) {
            const box = document.getElementById('point-detail-box');
            box.style.display = 'block';
            const parts = data.timeLabel.split(' ');
            document.getElementById('detail-date').textContent = parts[0];
            document.getElementById('detail-time').textContent = parts[1] + ' น.';
            document.getElementById('detail-hr').textContent = data.heartRate;
            document.getElementById('detail-spo2').textContent = data.spo2;
            box.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        window.updateChartView = function() {
            if (!chartInstance) return;
            const isHr = window.currentMetricView === 'hr';
            const isSpo2 = window.currentMetricView === 'spo2';
            chartInstance.setDatasetVisibility(0, !isSpo2);
            chartInstance.setDatasetVisibility(1, !isHr);
            
            if (isSpo2) {
                chartInstance.options.scales.y.min = 85;
                chartInstance.options.scales.y.max = 100;
            } else {
                chartInstance.options.scales.y.min = 40;
                chartInstance.options.scales.y.max = 120;
            }
            chartInstance.update();
        }

        function applyFilters() {
            if (allData.length === 0) return;
            if (currentFilterMode === 'date') {
                filteredData = allData.filter(item => {
                    const d = new Date(item.rawTimestamp);
                    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` === selectedFilterValue;
                });
            } else if (currentFilterMode === 'month') {
                filteredData = allData.filter(item => {
                    const d = new Date(item.rawTimestamp);
                    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}` === selectedFilterValue;
                });
            }
            renderTable();
            updateChartData();
        }

        function renderTable() {
            const body = document.getElementById('data-table-body');
            const pages = Math.ceil(filteredData.length / ROWS_PER_PAGE) || 1;
            if (currentPage > pages) currentPage = pages;
            const pageData = filteredData.slice((currentPage - 1) * ROWS_PER_PAGE, currentPage * ROWS_PER_PAGE);
            
            body.innerHTML = pageData.length ? pageData.map(item => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-4 py-4 text-[10px] sm:text-xs font-medium text-gray-500 whitespace-nowrap">${item.timeLabel}</td>
                    <td class="px-4 py-4 text-sm font-black ${item.heartRate > 100 || item.heartRate < 60 ? 'text-red-500' : 'text-gray-700'}">${item.heartRate}</td>
                    <td class="px-4 py-4 text-sm font-black ${item.spo2 < 95 ? 'text-red-500' : 'text-gray-700'}">${item.spo2}</td>
                </tr>
            `).join('') : '<tr><td colspan="3" class="p-8 text-center text-sm text-gray-300">ไม่พบข้อมูล</td></tr>';

            document.getElementById('current-page-num').textContent = currentPage;
            document.getElementById('total-pages-num').textContent = pages;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === pages;
        }

        function updateChartData() {
            if (!filteredData.length) {
                chartInstance.data.labels = [];
                chartInstance.data.datasets[0].data = [];
                chartInstance.data.datasets[1].data = [];
                chartInstance.update();
                return;
            }
            const sampled = filteredData.length > 300 ? filteredData.filter((_, i) => i % Math.ceil(filteredData.length / 300) === 0) : filteredData;
            chartRawObjects = [...sampled].sort((a,b) => a.rawTimestamp - b.rawTimestamp);
            
            chartInstance.data.labels = chartRawObjects.map(d => {
                const date = new Date(d.rawTimestamp);
                return currentFilterMode === 'month' ? `${date.getDate()}/${date.getMonth()+1}` : `${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
            });
            chartInstance.data.datasets[0].data = chartRawObjects.map(d => d.heartRate);
            chartInstance.data.datasets[1].data = chartRawObjects.map(d => d.spo2);
            window.updateChartView();
        }

        function listenToData() {
            onSnapshot(query(collection(db, COLLECTION_PATH), orderBy("timestamp", "desc")), (snap) => {
                allData = snap.docs.map(doc => {
                    const d = doc.data();
                    const date = d.timestamp?.seconds ? new Date(d.timestamp.seconds * 1000) : new Date(d.timestamp);
                    return {
                        timeLabel: isNaN(date) ? '--' : date.toLocaleString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }),
                        heartRate: d.heartRate || 0,
                        spo2: d.spo2 || 0,
                        rawTimestamp: isNaN(date) ? 0 : date.getTime()
                    };
                });
                if (allData.length) {
                    const latest = allData[0];
                    document.getElementById('current-hr').textContent = latest.heartRate;
                    document.getElementById('current-spo2').textContent = latest.spo2;
                    document.getElementById('hr-status').textContent = latest.heartRate > 100 ? 'High' : (latest.heartRate < 60 ? 'Low' : 'Normal');
                    document.getElementById('hr-status').className = `text-[10px] font-bold px-2 py-1 rounded-full uppercase ${latest.heartRate > 100 || latest.heartRate < 60 ? 'bg-red-50 text-red-500' : 'bg-green-50 text-green-500'}`;
                    document.getElementById('spo2-status').textContent = latest.spo2 < 95 ? 'Low' : 'Normal';
                    document.getElementById('spo2-status').className = `text-[10px] font-bold px-2 py-1 rounded-full uppercase ${latest.spo2 < 95 ? 'bg-red-50 text-red-500' : 'bg-green-50 text-green-500'}`;
                    document.getElementById('latest-reading').innerHTML = `<p class="text-sm font-bold text-gray-500">อัปเดตล่าสุด: <span class="text-indigo-600">${latest.timeLabel}</span></p>`;
                }
                applyFilters();
            });
        }

        document.getElementById('date-picker').onchange = (e) => {
            currentFilterMode = 'date'; selectedFilterValue = e.target.value;
            document.getElementById('month-picker').value = ''; applyFilters();
        };
        document.getElementById('month-picker').onchange = (e) => {
            currentFilterMode = 'month'; selectedFilterValue = e.target.value;
            document.getElementById('date-picker').value = ''; applyFilters();
        };
        document.getElementById('prev-page').onclick = () => { if (currentPage > 1) { currentPage--; renderTable(); } };
        document.getElementById('next-page').onclick = () => { if (currentPage < Math.ceil(filteredData.length / ROWS_PER_PAGE)) { currentPage++; renderTable(); } };

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('date-picker').value = todayStr;
            initializeChart();
            db = getFirestore(initializeApp(firebaseConfig));
            listenToData();
            document.getElementById('path-display').textContent = COLLECTION_PATH;
        });
    </script>
</body>
</html>