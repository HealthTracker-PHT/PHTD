<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vital Signs Realtime Dashboard (Full Version)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Load jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Load PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=K2D:wght@400;700&display=swap');
        
        :root {
            --nav-height: 70px;
        }
        html {
            overflow-y: scroll; 
            scrollbar-gutter: stable;
        }
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        body {
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            font-family: 'K2D', sans-serif; 
            background-color: #f3f4f6;
            overflow: hidden;
        }

        .cover3man { 
            width: 100vw; 
            height: calc(100vh - var(--nav-height) - env(safe-area-inset-bottom)); 
            overflow: hidden; 
            position: relative; 
        }
        
        .div-mainpage333 { 
            display: flex; 
            width: 300vw; 
            height: 100%; 
            position: absolute; 
            top: 0; 
            left: 0; 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        
        .coveruserpage, .coverhomebooking, .covertotalbooking { 
            width: 100vw; 
            height: 100%; 
            flex-shrink: 0; 
            overflow: hidden; 
        }

        .left1 { transform: translateX(0); }
        .center00 { transform: translateX(-100vw); }
        .right2 { transform: translateX(-200vw); }

        /* Unified scroll container style */
        .page-content-scroll { 
            height: 100%; 
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
        }
        
        .content-wrapper { 
            width: 100%; 
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        
        .bottom-nav-container { 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            z-index: 50; 
            height: calc(var(--nav-height) + env(safe-area-inset-bottom)); 
            display: flex; 
            justify-content: center;
            background-color: white;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
        }
        
        .covermenubot { 
            display: flex; 
            justify-content: space-around; 
            align-items: flex-start;
            padding-top: 12px;
            height: var(--nav-height); 
            width: 100%; 
        }
        
        .sub-botmenu { 
            cursor: pointer; 
            width: 33.33%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 44px; 
            transition: all 0.2s; 
        }
        
        .icon-size { width: 26px; height: 26px; } 

        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5); } }
        
        .picker-input { border: 1.5px solid #e5e7eb; padding: 0.4rem 0.8rem; border-radius: 0.75rem; font-size: 0.875rem; width: 100%; outline: none; transition: all 0.2s; background: #fff; }
        
        .metric-tab { cursor: pointer; padding: 0.6rem; font-size: 0.75rem; border-radius: 0.75rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); text-align: center; flex: 1; color: #9ca3af; font-weight: 800; }
        .metric-tab.active { background-color: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25); }

        #point-detail-box { 
            display: none; 
            background: #f8fafc; 
            border-left: 6px solid #4f46e5; 
            padding: 1.25rem; 
            margin-top: 1.25rem; 
            border-radius: 1rem; 
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Heartbeat line animation */
        .ecg-line {
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            animation: ecg-flow 2s infinite linear;
        }
        @keyframes ecg-flow {
            0% { stroke-dashoffset: 100; }
            100% { stroke-dashoffset: -100; }
        }

        /* PDF Export Styles - Classic Layout */
        #pdf-export-template {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 800px;
            background: #ffffff;
            padding: 40px 40px 80px 40px; 
            color: #000;
        }
        
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            border: 1.5px solid #000;
        }
        
        .pdf-table th, .pdf-table td {
            border: 1.5px solid #000;
            padding: 8px;
            text-align: center;
        }
        
        .pdf-header-box {
            border-bottom: 3px solid #000;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .pdf-info-card {
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 20px; 
            padding: 15px; 
            border: 1.5px solid #000; 
        }

        .pdf-chart-container {
            width: 100%; 
            height: 300px; 
            border: 1.5px solid #000; 
            padding: 10px;
            margin-bottom: 15px;
            background: #fff;
        }

        /* Helper animations for screen switching */
        .fade-in { animation: fadeIn 0.3s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>

<body>

    <!-- PDF Template (Hidden) -->
    <div id="pdf-export-template">
        <div class="pdf-header-box">
            <h1 style="font-size: 24px; font-weight: 800; color: #000; margin: 0;">รายงานผลการตรวจสุขภาพส่วนบุคคล</h1>
            <p style="font-size: 13px; color: #333; margin: 2px 0 0 0;">Personal Vital Signs Full History Report</p>
        </div>
        
        <div class="pdf-info-card">
            <div>
                <p style="font-size: 9px; color: #555; text-transform: uppercase; font-weight: bold; margin: 0 0 3px 0;">ชื่อ-นามสกุล</p>
                <p id="pdf-name" style="font-size: 15px; font-weight: bold; margin: 0;">--</p>
            </div>
            <div>
                <p style="font-size: 9px; color: #555; text-transform: uppercase; font-weight: bold; margin: 0 0 3px 0;">อายุ</p>
                <p id="pdf-age" style="font-size: 15px; font-weight: bold; margin: 0;">-- ปี</p>
            </div>
            <div>
                <p style="font-size: 9px; color: #555; text-transform: uppercase; font-weight: bold; margin: 0 0 3px 0;">ประเภทรายงาน</p>
                <p id="pdf-report-type" style="font-size: 15px; font-weight: bold; margin: 0; color: #4f46e5;">ประวัติทั้งหมด</p>
            </div>
        </div>

        <div id="pdf-chart-section">
            <h3 style="font-size: 13px; font-weight: 800; margin-bottom: 8px; color: #000;">กราฟสรุปแนวโน้มสัญญาณชีพ (HR & SpO₂)</h3>
            <div class="pdf-chart-container">
                <img id="pdf-chart-img" style="width: 100%; height: 100%; object-fit: contain;" />
            </div>
        </div>

        <div id="pdf-table-section">
            <h3 id="pdf-table-title" style="font-size: 13px; font-weight: 800; margin-bottom: 8px; color: #000;">รายการบันทึกข้อมูลสุขภาพ</h3>
            <table class="pdf-table">
                <thead>
                    <tr style="background: #f0f0f0; color: #000;">
                        <th style="width: 60px;">ครั้งที่</th>
                        <th>วัน/เวลา</th>
                        <th style="width: 150px;">Heart Rate (bpm)</th>
                        <th style="width: 150px;">SpO₂ (%)</th>
                    </tr>
                </thead>
                <tbody id="pdf-table-body" style="font-size: 11px; color: #000;"></tbody>
            </table>
        </div>

        <div id="pdf-footer" style="margin-top: 25px; border-top: 1px solid #000; padding-top: 10px; display: flex; justify-content: space-between; font-size: 9px; color: #444;">
            <span>สร้างโดย Vital Signs System เมื่อ: <span id="pdf-gen-time">--</span></span>
            <p id="pdf-page-number" style="font-weight: bold; margin: 0;">หน้า 1 จาก 1</p>
        </div>
    </div>

    <!-- 1. Authentication Screen (Login/Register) -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="auth-card w-full max-w-md bg-white p-10 rounded-[2.5rem] shadow-2xl relative">
            <div class="text-center mb-8 relative">
                <!-- Back Button for Registration Mode -->
                <button id="auth-back-btn" onclick="toggleAuthMode()" class="hidden absolute left-0 top-0 p-2 text-gray-400 hover:text-indigo-600 transition-all">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                </button>

                <div class="bg-blue-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-200">
                    <svg class="w-10 h-10" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M32 56s-20-12.5-26-24C1.5 22 6 10 18 10c6 0 10 4 14 8 4-4 8-8 14-8 12 0 16.5 12 12 22-6 11.5-26 24-26 24z" fill="white" />
                        <path d="M14 34h8l4-8 6 16 5-10h9" class="ecg-line" stroke="#2563EB" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <h2 id="auth-title" class="text-3xl font-black text-gray-800 leading-tight">บันทึกประวัติสุขภาพ</h2>
            </div>
            <div class="space-y-4">
                <div id="register-only-fields" class="hidden space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <input id="firstName" type="text" placeholder="ชื่อ" class="w-full p-4 bg-gray-50 border-none rounded-2xl outline-none font-bold transition-all focus:ring-2 focus:ring-indigo-100">
                        <input id="lastName" type="text" placeholder="นามสกุล" class="w-full p-4 bg-gray-50 border-none rounded-2xl outline-none font-bold transition-all focus:ring-2 focus:ring-indigo-100">
                    </div>
                    <input id="birthDate" type="date" class="w-full p-4 bg-gray-50 border-none rounded-2xl outline-none text-gray-500 font-bold transition-all focus:ring-2 focus:ring-indigo-100">
                </div>
                <input id="email" type="email" placeholder="อีเมล" class="w-full p-4 bg-gray-50 border-none rounded-2xl outline-none font-bold transition-all focus:ring-2 focus:ring-indigo-100">
                <input id="password" type="password" placeholder="รหัสผ่าน" class="w-full p-4 bg-gray-50 border-none rounded-2xl outline-none font-bold transition-all focus:ring-2 focus:ring-indigo-100">
                <div id="register-confirm-field" class="hidden"><input id="confirm-password" type="password" placeholder="ยืนยันรหัสผ่าน" class="w-full p-4 bg-gray-50 border-none rounded-2xl outline-none font-bold transition-all focus:ring-2 focus:ring-indigo-100"></div>
                
                <!-- Link to Forgot Password -->
                <div id="forgot-password-link" class="text-right px-2">
                    <button onclick="goToForgotPw()" class="text-xs text-indigo-500 font-bold hover:underline">ลืมรหัสผ่าน?</button>
                </div>

                <div id="error-msg" class="text-red-500 text-sm text-center hidden font-bold"></div>
                <button id="auth-submit-btn" onclick="handleAuthSubmit()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-2xl shadow-xl transition-all active:scale-95">Login</button>
                <button id="auth-toggle-btn" onclick="toggleAuthMode()" class="w-full text-gray-400 font-bold py-2 hover:text-indigo-600 transition-all">Create Account</button>
            </div>
        </div>
    </div>

    <!-- 1.1 Forgot Password Screen (หน้าแยก) -->
    <div id="forgot-pw-screen" class="min-h-screen hidden flex items-center justify-center p-4">
        <div class="auth-card w-full max-w-md bg-white p-10 rounded-[2.5rem] shadow-2xl">
            <div class="text-center mb-8">
                <div class="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-200">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                </div>
                <h2 class="text-3xl font-black text-gray-800 leading-tight">กู้คืนรหัสผ่าน</h2>
                <p class="text-xs text-gray-400 font-bold mt-2 text-center">กรอกอีเมลของคุณเพื่อรับลิงก์สำหรับตั้งรหัสผ่านใหม่</p>
            </div>
            <div class="space-y-4">
                <input id="forgot-email" type="email" placeholder="ระบุอีเมลผู้ใช้งาน" class="w-full p-4 bg-gray-50 border-none rounded-2xl outline-none font-bold transition-all focus:ring-2 focus:ring-indigo-100">
                <div id="forgot-error-msg" class="text-red-500 text-sm text-center hidden font-bold"></div>
                <button id="forgot-submit-btn" onclick="executeForgotPassword()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-2xl shadow-xl transition-all active:scale-95">ส่งคำขอรีเซ็ตรหัสผ่าน</button>
                <button onclick="backToLogin()" class="w-full text-gray-400 font-bold py-2 hover:text-indigo-600 transition-all flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    กลับหน้าเข้าสู่ระบบ
                </button>
            </div>
        </div>
    </div>

    <!-- 2. Dashboard Screen -->
    <div id="dashboard-screen" class="hidden">
        <div class="cover3man">
            <div id="mainpage333" class="div-mainpage333 center00">
                
                <!-- Page 1: Settings (Unified Stretched Card) -->
                <div id="user-page" class="coveruserpage page-content-scroll">
                    <div class="content-wrapper">
                        <div class="mt-4"></div> 
                        <div class="bg-white p-6 rounded-t-[2.5rem] rounded-b-none shadow-2xl border-x border-t border-gray-100 flex-1 flex flex-col relative min-h-full pb-[100px]">
                            <!-- Profile Section -->
                            <div class="flex flex-col items-center pb-6 border-b border-gray-50 relative">
                                <div class="relative group">
                                    <div id="profile-img-container" class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center overflow-hidden border-4 border-white shadow-sm mb-3">
                                        <img id="profile-avatar" class="hidden w-full h-full object-cover" src="" alt="Avatar">
                                        <svg id="profile-placeholder" class="w-12 h-12 text-indigo-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                    </div>
                                    <label for="profile-image-upload" class="absolute bottom-2 right-0 bg-indigo-600 text-white p-1.5 rounded-full cursor-pointer shadow-lg hover:scale-110 active:scale-95 transition-all border-2 border-white">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                    </label>
                                    <input id="profile-image-upload" type="file" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                                </div>
                                
                                <div class="flex items-center gap-2 mb-1">
                                    <h3 id="profile-display-name" class="text-lg font-black text-gray-800 leading-tight">--</h3>
                                    <button onclick="openEditProfile()" class="p-1.5 bg-indigo-50 text-indigo-600 rounded-full hover:bg-indigo-600 hover:text-white transition-all shadow-sm">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                    </button>
                                </div>
                                <p id="profile-display-age" class="text-indigo-600 font-bold text-xs">อายุ: -- ปี</p>
                                <p id="user-email-display-profile" class="text-[10px] text-gray-300 font-bold uppercase mt-1 tracking-widest">--</p>
                            </div>

                            <!-- Section: Device Connection -->
                            <div class="py-6 border-b border-gray-50">
                                <h3 class="text-sm font-black text-indigo-700 mb-1 uppercase tracking-wider">เชื่อมต่อเครื่องตรวจวัด</h3>
                                <p class="text-[10px] text-gray-400 mb-3 font-bold uppercase tracking-wider">ระบุ ID ของอุปกรณ์คุณ</p>
                                <div class="flex gap-2">
                                    <input id="device-id-input" type="text" placeholder="Device ID" class="flex-1 p-2.5 bg-gray-50 rounded-xl font-bold border-none text-sm outline-none transition-all focus:ring-2 focus:ring-indigo-100">
                                    <button onclick="saveDeviceId()" class="bg-indigo-600 text-white px-5 rounded-xl font-bold text-sm shadow-md active:scale-95 transition-all">Connect</button>
                                </div>
                            </div>

                            <!-- Section: User Manual -->
                            <div class="py-6 flex-1">
                                <h3 class="text-sm font-black text-indigo-700 mb-4 uppercase tracking-wider">คู่มือการใช้งานแบบละเอียด</h3>
                                <div class="space-y-5 pr-1 overflow-y-auto">
                                    <div class="flex gap-3 items-start">
                                        <span class="w-6 h-6 bg-indigo-50 text-indigo-600 rounded-lg flex items-center justify-center text-[10px] font-black flex-shrink-0 mt-0.5 shadow-sm">1</span>
                                        <div class="flex-1">
                                            <p class="text-[11px] text-gray-800 font-black mb-1">การเชื่อมต่ออุปกรณ์</p>
                                            <p class="text-[10px] text-gray-500 font-bold leading-relaxed">กรอกรหัส Device ID ประจำตัวเครื่องในช่องด้านบนแล้วกด Connect เพื่อผูกสัญญาณสด</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-3 items-start">
                                        <span class="w-6 h-6 bg-indigo-50 text-indigo-600 rounded-lg flex items-center justify-center text-[10px] font-black flex-shrink-0 mt-0.5 shadow-sm">2</span>
                                        <div class="flex-1">
                                            <p class="text-[11px] text-gray-800 font-black mb-1">การดูผลแบบเรียลไทม์</p>
                                            <p class="text-[10px] text-gray-500 font-bold leading-relaxed">หน้าจอ "จอแสดงผล" จะแสดงค่า HR และ SpO₂ ทันทีที่มีการวัด พร้อมสถานะสีเพื่อความปลอดภัย</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-3 items-start">
                                        <span class="w-6 h-6 bg-indigo-50 text-indigo-600 rounded-lg flex items-center justify-center text-[10px] font-black flex-shrink-0 mt-0.5 shadow-sm">3</span>
                                        <div class="flex-1">
                                            <p class="text-[11px] text-gray-800 font-black mb-1">การบันทึกประวัติ</p>
                                            <p class="text-[10px] text-gray-500 font-bold leading-relaxed">กด "เริ่มบันทึก" เพื่อจัดเก็บข้อมูลลงในฐานข้อมูลออนไลน์สำหรับวิเคราะห์แนวโน้มสุขภาพ</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-3 items-start">
                                        <span class="w-6 h-6 bg-indigo-50 text-indigo-600 rounded-lg flex items-center justify-center text-[10px] font-black flex-shrink-0 mt-0.5 shadow-sm">4</span>
                                        <div class="flex-1">
                                            <p class="text-[11px] text-gray-800 font-black mb-1">การดูประวัติและออกรายงาน</p>
                                            <p class="text-[10px] text-gray-500 font-bold leading-relaxed">เลือกดูข้อมูลย้อนหลังตามวันหรือเดือนผ่านกราฟและตาราง พร้อมปุ่มดาวน์โหลดรายงาน PDF เพื่อบันทึกผลสุขภาพ</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Section: Account Security & Logout -->
                            <div class="pt-6 space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="openChangePassword()" class="w-full py-3 bg-indigo-50 text-indigo-600 font-black rounded-2xl border border-indigo-100 active:scale-95 transition-all text-[10px] uppercase tracking-wider">เปลี่ยนรหัสผ่าน</button>
                                    <button onclick="openDeleteAccount()" class="w-full py-3 bg-red-50 text-red-600 font-black rounded-2xl border border-red-100 active:scale-95 transition-all text-[10px] uppercase tracking-wider">ลบบัญชีผู้ใช้</button>
                                </div>
                                <button onclick="logout()" class="w-full py-3.5 bg-red-50 text-red-500 font-black rounded-2xl border border-red-100 active:scale-95 transition-all text-xs uppercase tracking-widest">ออกจากระบบ</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Page 2: Realtime (Unified Stretched Card) -->
                <div id="metrics-page" class="coverhomebooking page-content-scroll">
                    <div class="content-wrapper">
                        <div class="bg-white p-5 pt-8 rounded-t-[2.5rem] rounded-b-none shadow-2xl border-x border-t border-gray-100 flex-1 flex flex-col relative overflow-hidden min-h-full pb-[100px]">
                            <!-- Header Info -->
                            <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-50">
                                <div class="flex flex-col">
                                    <h2 class="text-xl font-black text-gray-800 leading-none mb-1">จอแสดงผล</h2>
                                    <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest leading-none">Realtime Status</p>
                                </div>
                                <div class="inline-flex items-center gap-1.5 bg-indigo-50 px-3 py-1 rounded-full border border-indigo-100">
                                    <span class="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-pulse"></span>
                                    <p id="latest-ts-display" class="text-[10px] font-bold text-indigo-600">ล่าสุด: <span id="last-saved-display">--:--</span></p>
                                </div>
                            </div>
                            
                            <!-- Recording Bar -->
                            <div id="recording-bar" class="bg-gray-50 p-3 rounded-2xl mb-4 border border-gray-100 transition-all">
                                <div class="flex justify-between items-center">
                                    <div class="text-left">
                                        <h3 id="rec-title" class="text-xs font-black text-gray-700 leading-tight">โหมดดูอย่างเดียว</h3>
                                        <p id="rec-status" class="text-[8px] text-gray-400 font-bold uppercase">Ready to Record</p>
                                    </div>
                                    <button id="btn-record" onclick="toggleRecording()" class="bg-white text-gray-600 px-4 py-1.5 rounded-xl font-black text-[10px] flex items-center gap-2 shadow-sm border border-gray-100 active:scale-95 transition-all">
                                        <span class="w-1.5 h-1.5 bg-gray-400 rounded-full" id="rec-dot"></span>
                                        เริ่มบันทึก
                                    </button>
                                </div>
                            </div>

                            <!-- Metrics Data (Stacked) -->
                            <div class="space-y-3 mb-4">
                                <div class="bg-red-50/20 px-4 py-4 rounded-2xl border border-red-100 flex justify-between items-center transition-all">
                                    <div class="text-left">
                                        <p class="text-[10px] font-black text-red-300 uppercase tracking-widest mb-1">Heart Rate</p>
                                        <div class="flex items-baseline gap-1">
                                            <span id="current-hr" class="text-4xl font-black text-red-600 leading-none">--</span>
                                            <span class="text-red-400 font-bold text-xs uppercase">bpm</span>
                                        </div>
                                    </div>
                                    <span id="hr-status" class="px-3 py-1 rounded-lg bg-white border border-red-50 text-red-400 font-bold text-[10px]">Wait</span>
                                </div>
                                <div class="bg-blue-50/20 px-4 py-4 rounded-2xl border border-blue-100 flex justify-between items-center transition-all">
                                    <div class="text-left">
                                        <p class="text-[10px] font-black text-blue-300 uppercase tracking-widest mb-1">Oxygen SpO₂</p>
                                        <div class="flex items-baseline gap-1">
                                            <span id="current-spo2" class="text-4xl font-black text-blue-600 leading-none">--</span>
                                            <span class="text-blue-400 font-bold text-xs">%</span>
                                        </div>
                                    </div>
                                    <span id="spo2-status" class="px-3 py-1 rounded-lg bg-white border border-blue-50 text-blue-400 font-bold text-[10px]">Wait</span>
                                </div>
                            </div>

                            <!-- Detailed Criteria Table -->
                            <div class="flex-grow flex flex-col bg-gray-50/30 rounded-3xl p-4 border border-gray-100 overflow-hidden">
                                <h3 class="text-[10px] font-black text-indigo-400 mb-3 uppercase tracking-widest text-center">เกณฑ์มาตรฐานสัญญาณชีพ</h3>
                                <div class="overflow-y-auto pr-1">
                                    <table class="w-full text-[9px] text-left border-separate border-spacing-y-1.5">
                                        <thead><tr class="text-gray-400"><th class="pl-2 font-black">ประเภท</th><th class="font-black">เกณฑ์</th><th class="pr-2 text-right font-black">สถานะ</th></tr></thead>
                                        <tbody>
                                            <tr class="bg-white rounded-lg shadow-sm"><td class="py-2 pl-3 font-bold text-red-500">Heart Rate</td><td>&lt; 60 bpm</td><td class="pr-3 text-right text-orange-500 font-bold">เต้นช้า</td></tr>
                                            <tr class="bg-white rounded-lg shadow-sm"><td class="py-2 pl-3"></td><td class="font-bold text-green-600">60-100 bpm</td><td class="pr-3 text-right text-green-600 font-bold">ปกติ</td></tr>
                                            <tr class="bg-white rounded-lg shadow-sm"><td class="py-2 pl-3"></td><td>&gt; 100 bpm</td><td class="pr-3 text-right text-red-500 font-bold">เต้นเร็ว</td></tr>
                                            <tr class="bg-white rounded-lg shadow-sm"><td class="py-2 pl-3 font-bold text-blue-500">Oxygen SpO₂</td><td class="font-bold text-green-600">95-100%</td><td class="pr-3 text-right text-green-600 font-bold">ปกติ</td></tr>
                                            <tr class="bg-white rounded-lg shadow-sm"><td class="py-2 pl-3"></td><td class="text-yellow-600">90-94%</td><td class="pr-3 text-right text-yellow-600 font-bold">เริ่มต่ำ</td></tr>
                                            <tr class="bg-white rounded-lg shadow-sm"><td class="py-2 pl-3"></td><td class="text-red-600 font-black">&lt; 90%</td><td class="pr-3 text-right text-red-600 font-black italic">อันตราย!</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-4">
                                    <p class="text-[10px] text-yellow-700 font-bold text-center flex items-center justify-center gap-1.5 bg-yellow-50 py-2.5 rounded-xl border border-yellow-200">
                                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                        โปรดปรึกษาแพทย์หากมีอาการผิดปกติ
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Page 3: History (Unified Stretched Card) -->
                <div id="history-page" class="covertotalbooking page-content-scroll">
                    <div class="content-wrapper">
                        <div class="bg-white p-5 pt-8 rounded-t-[2.5rem] rounded-b-none shadow-2xl border-x border-t border-gray-100 flex-1 flex flex-col relative min-h-full pb-[100px]">
                            <!-- Section: Control Header -->
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-5 pb-5 border-b border-gray-50 items-end text-center">
                                <div class="flex flex-col text-left">
                                    <label class="text-[9px] font-black text-gray-400 block mb-1 uppercase tracking-widest ml-2">เลือกวัน</label>
                                    <input type="date" id="date-picker" class="picker-input font-bold text-gray-700 shadow-sm w-full h-[40px] text-xs transition-all focus:ring-2 focus:ring-indigo-100">
                                </div>
                                <div class="flex flex-col text-left">
                                    <label class="text-[9px] font-black text-gray-400 block mb-1 uppercase tracking-widest ml-2">เลือกเดือน</label>
                                    <input type="month" id="month-picker" class="picker-input font-bold text-gray-700 shadow-sm w-full h-[40px] text-xs transition-all focus:ring-2 focus:ring-indigo-100">
                                </div>
                                <button onclick="resetToAll()" class="bg-indigo-50 text-indigo-600 rounded-xl border border-indigo-100 shadow-sm hover:bg-indigo-600 hover:text-white transition-all text-[10px] font-black uppercase active:scale-95 h-[40px]">
                                    แสดงทั้งหมด
                                </button>
                                <button id="btn-main-report" onclick="downloadPDF()" class="bg-indigo-50 text-indigo-600 rounded-xl border border-indigo-100 shadow-sm hover:bg-indigo-600 hover:text-white transition-all flex items-center justify-center gap-1 text-[10px] font-black uppercase active:scale-95 h-[40px]">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    รายงาน
                                </button>
                            </div>

                            <!-- Section: Graph Tabs -->
                            <div class="flex bg-gray-50 p-1 rounded-xl gap-1 mb-4 border border-gray-100">
                                <div onclick="setMetricView('both')" id="tab-both" class="metric-tab active !text-[10px] !py-1">ทั้งคู่</div>
                                <div onclick="setMetricView('hr')" id="tab-hr" class="metric-tab !text-[10px] !py-1">HR</div>
                                <div onclick="setMetricView('spo2')" id="tab-spo2" class="metric-tab !text-[10px] !py-1">SpO₂</div>
                            </div>

                            <!-- Section: Chart -->
                            <div class="h-[200px] mb-2"><canvas id="chart"></canvas></div>

                            <!-- Section: Point Detail -->
                            <div id="point-detail-box">
                                <div class="flex justify-between items-center">
                                    <div class="flex-1 text-left">
                                        <div class="flex items-center gap-2 mb-0.5">
                                            <span id="detail-count" class="bg-indigo-600 text-white text-[8px] px-2 py-0.5 rounded-full font-bold uppercase tracking-tighter">--</span>
                                            <p id="detail-date" class="text-sm text-indigo-800 font-black">--</p>
                                        </div>
                                        <p id="detail-time" class="text-[10px] text-gray-400 font-medium">กดจุดบนกราฟเพื่อดูรายละเอียด</p>
                                    </div>
                                    <div class="flex gap-3 text-center border-l border-gray-100 pl-3">
                                        <div><p class="text-[7px] text-red-400 font-bold uppercase">HR</p><p id="detail-hr" class="text-lg font-black text-red-600 leading-none">--</p></div>
                                        <div><p class="text-[7px] text-blue-400 font-bold uppercase">SpO2</p><p id="detail-spo2" class="text-lg font-black text-indigo-600 leading-none">--</p></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Section: Table -->
                            <div class="mt-8 flex-1">
                                <div class="flex justify-between items-center mb-3 px-1">
                                    <h3 class="text-xs font-black text-gray-800 uppercase tracking-tighter text-left">ตารางประวัติ</h3>
                                    <div class="text-[9px] font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-full"><span id="current-page-num">1</span> / <span id="total-pages-num">1</span></div>
                                </div>
                                <div id="data-table-container" class="overflow-x-auto rounded-lg border border-gray-50 mb-4">
                                    <table class="w-full text-center">
                                        <thead class="text-[9px] font-black text-gray-400 uppercase bg-gray-50/50">
                                            <tr><th class="py-2">ครั้งที่</th><th>วัน/เวลา</th><th>HR</th><th>SpO₂</th></tr>
                                        </thead>
                                        <tbody id="data-table-body" class="divide-y divide-gray-50 text-[11px]"></tbody>
                                    </table>
                                </div>
                                <div class="flex justify-between gap-3">
                                    <button id="prev-page" class="flex-1 py-2 bg-gray-50 text-gray-400 font-bold rounded-xl text-[10px] disabled:opacity-30">ก่อนหน้า</button>
                                    <button id="next-page" class="flex-1 py-2 bg-indigo-50 text-indigo-600 font-bold rounded-xl text-[10px] disabled:opacity-30">ถัดไป</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-nav-container">
            <div class="covermenubot">
                <div onclick="switchTab(1)" class="sub-botmenu"><svg id="nav-icon-1" class="icon-size text-gray-300 transition-colors" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>
                <div onclick="switchTab(2)" class="sub-botmenu"><div id="nav-icon-center" class="h-14 w-14 rounded-2xl bg-indigo-600 flex items-center justify-center -mt-8 shadow-xl text-white transition-all transform hover:scale-110"><svg class="h-8 w-8" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></div></div>
                <div onclick="switchTab(3)" class="sub-botmenu"><svg id="nav-icon-3" class="icon-size text-gray-300 transition-colors" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3h-2V1h-2v2H9V1H7v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zm-5-8H9c-.55 0-1 .45-1 1s.45 1 1 1h5c.55 0 1-.45 1-1s-.45-1-1-1z"/></svg></div>
            </div>
        </div>
    </div>

    <!-- Modals: Profile Edit -->
    <div id="edit-profile-overlay" class="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center hidden backdrop-blur-sm">
        <div id="edit-profile-modal" class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-[90%] max-w-md popup-out text-center">
            <h3 class="text-2xl font-black text-gray-800 mb-6">แก้ไขข้อมูลส่วนตัว</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-left"><label class="text-[10px] font-black text-gray-400 block ml-2 mb-1 uppercase">ชื่อ</label><input id="edit-firstName" type="text" class="w-full p-4 bg-gray-50 border-none rounded-2xl font-bold outline-none transition-all focus:ring-2 focus:ring-indigo-100"></div>
                    <div class="text-left"><label class="text-[10px] font-black text-gray-400 block ml-2 mb-1 uppercase">นามสกุล</label><input id="edit-lastName" type="text" class="w-full p-4 bg-gray-50 border-none rounded-2xl font-bold outline-none transition-all focus:ring-2 focus:ring-indigo-100"></div>
                </div>
                <div class="text-left"><label class="text-[10px] font-black text-gray-400 block ml-2 mb-1 uppercase">วันเดือนปีเกิด</label><input id="edit-birthDate" type="date" class="w-full p-4 bg-gray-50 border-none rounded-2xl font-bold outline-none text-gray-700 transition-all focus:ring-2 focus:ring-indigo-100"></div>
                <div class="flex gap-4 pt-4"><button onclick="closeEditProfile()" class="flex-1 py-4 bg-gray-100 text-gray-400 font-bold rounded-2xl active:scale-95 transition-all">ยกเลิก</button><button id="btn-save-profile" onclick="handleSaveProfile()" class="flex-1 py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-lg active:scale-95 transition-all">บันทึก</button></div>
            </div>
        </div>
    </div>

    <!-- Modals: Change Password -->
    <div id="change-password-overlay" class="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center hidden backdrop-blur-sm">
        <div id="change-password-modal" class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-[90%] max-w-md popup-out text-center">
            <h3 class="text-2xl font-black text-gray-800 mb-6">เปลี่ยนรหัสผ่าน</h3>
            <div class="space-y-4">
                <input id="old-password" type="password" placeholder="รหัสผ่านเดิม" class="w-full p-4 bg-gray-50 border-none rounded-2xl font-bold outline-none transition-all focus:ring-2 focus:ring-indigo-100">
                <input id="new-password" type="password" placeholder="รหัสผ่านใหม่" class="w-full p-4 bg-gray-50 border-none rounded-2xl font-bold outline-none transition-all focus:ring-2 focus:ring-indigo-100">
                <input id="confirm-new-password" type="password" placeholder="ยืนยันรหัสผ่านใหม่" class="w-full p-4 bg-gray-50 border-none rounded-2xl font-bold outline-none transition-all focus:ring-2 focus:ring-indigo-100">
                <div class="flex gap-4 pt-4">
                    <button onclick="closeChangePassword()" class="flex-1 py-4 bg-gray-100 text-gray-400 font-bold rounded-2xl active:scale-95 transition-all">ยกเลิก</button>
                    <button id="btn-confirm-change-pw" onclick="handleChangePassword()" class="flex-1 py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-lg active:scale-95 transition-all">ตกลง</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals: Delete Account -->
    <div id="delete-account-overlay" class="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center hidden backdrop-blur-sm">
        <div id="delete-account-modal" class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-[90%] max-w-md popup-out text-center">
            <h3 class="text-2xl font-black text-gray-800 mb-2">ยืนยันการลบบัญชี</h3>
            <p class="text-red-500 text-xs font-bold mb-6">คำเตือน: ข้อมูลทั้งหมดของคุณจะถูกลบถาวร!</p>
            <div class="space-y-4">
                <input id="del-confirm-password" type="password" placeholder="กรุณากรอกรหัสผ่านเพื่อยืนยัน" class="w-full p-4 bg-gray-50 border-none rounded-2xl font-bold outline-none transition-all focus:ring-2 focus:ring-indigo-100">
                <div class="flex gap-4 pt-4">
                    <button onclick="closeDeleteAccount()" class="flex-1 py-4 bg-gray-100 text-gray-400 font-bold rounded-2xl active:scale-95 transition-all">ยกเลิก</button>
                    <button id="btn-confirm-delete-acc" onclick="handleDeleteAccount()" class="flex-1 py-4 bg-red-600 text-white font-black rounded-2xl shadow-lg active:scale-95 transition-all">ยืนยันการลบ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Popup -->
    <div id="popup-overlay" class="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center hidden backdrop-blur-sm">
        <div id="custom-popup" class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-[90%] max-sm text-center popup-out border-2 border-indigo-50">
            <div id="popup-icon-container" class="w-16 h-16 rounded-3xl flex items-center justify-center mx-auto mb-4 transition-colors shadow-inner"><svg id="popup-svg" class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"></svg></div>
            <h3 id="popup-title" class="text-xl font-black text-gray-800 mb-1">สำเร็จ!</h3>
            <p id="popup-message" class="text-gray-500 mb-6 font-medium text-xs text-center px-4 leading-relaxed">--</p>
            <button id="popup-confirm-btn" onclick="closePopup()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-3 rounded-2xl shadow-lg active:scale-95 text-sm transition-all">ตกลง</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, reauthenticateWithCredential, EmailAuthProvider, updatePassword, deleteUser, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, onSnapshot, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";

        // Firebase config - placeholder as provided
        const firebaseConfig = { apiKey: "AIzaSyDzTkR7xbg9B6UkknvRXiuamWsBR1zIQ90", authDomain: "hrspo-98b0c.firebaseapp.com", projectId: "hrspo-98b0c", storageBucket: "hrspo-98b0c.appspot.com", messagingSenderId: "364239224326", appId: "1:364239224326:web:1e66faddd8e6dd2e718d87" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, pairedDeviceId = null, chartInstance = null, unsubscribeDevice = null, unsubscribeHistory = null, isRecording = false, lastTs = 0, allHist = [], filtHist = [], curPage = 1, curMetric = 'both', isRegisterMode = false, profileDataCache = null, isFirstDataLoad = true;
        const PAGE_SIZE = 10;
        let selectedFilter = "", filtMode = "all", chartRaw = [];

        function calculateAge(birthDateString) { if (!birthDateString) return "--"; const today = new Date(); const birthDate = new Date(birthDateString); let age = today.getFullYear() - birthDate.getFullYear(); const m = today.getMonth() - birthDate.getMonth(); if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--; return age; }

        window.showPopup = (title, message, isError = false) => {
            const container = $('#popup-icon-container'); const svg = $('#popup-svg'); const btn = $('#popup-confirm-btn');
            $('#popup-title').text(title); $('#popup-message').text(message);
            if (isError) { container.removeClass('bg-green-100').addClass('bg-red-50'); svg.removeClass('text-green-600').addClass('text-red-500'); svg.html('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path>'); btn.removeClass('bg-indigo-600').addClass('bg-red-600'); }
            else { container.removeClass('bg-red-100').addClass('bg-green-100'); svg.removeClass('text-red-500').addClass('text-green-600'); svg.html('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>'); btn.removeClass('bg-red-600').addClass('bg-indigo-600'); }
            $('#popup-overlay').removeClass('hidden'); setTimeout(() => $('#custom-popup').removeClass('popup-out').addClass('popup-in'), 10);
        };
        window.closePopup = () => { $('#custom-popup').removeClass('popup-in').addClass('popup-out'); setTimeout(() => $('#popup-overlay').addClass('hidden'), 300); };

        window.handleImageUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 800000) { 
                showPopup("รูปใหญ่เกินไป", "กรุณาเลือกรูปที่มีขนาดไม่เกิน 800KB เพื่อความรวดเร็วในการแสดงผล", true);
                return;
            }
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result;
                $('#profile-avatar').attr('src', base64).removeClass('hidden');
                $('#profile-placeholder').addClass('hidden');
                try {
                    await setDoc(doc(db, "users_profiles", currentUser.uid), { profileImage: base64 }, { merge: true });
                    showPopup("สำเร็จ!", "อัปเดตรูปโปรไฟล์เรียบร้อยแล้ว");
                } catch (err) {
                    showPopup("ล้มเหลว", "ไม่สามารถบันทึกรูปภาพได้", true);
                }
            };
            reader.readAsDataURL(file);
        };

        window.downloadPDF = async () => {
            const btnReport = $('#btn-main-report'); const originalBtnText = btnReport.html();
            try {
                const targetData = (filtMode === 'all') ? [...allHist] : [...filtHist]; 
                if (targetData.length === 0) { showPopup("ไม่พบข้อมูล", "กรุณาสร้างบันทึกข้อมูลก่อนสร้างรายงาน", true); return; }
                btnReport.prop('disabled', true).text('สร้าง...');
                const jspdfLib = window.jspdf ? window.jspdf.jsPDF : null;
                if (!jspdfLib || !window.html2canvas) throw new Error("ระบบสร้าง PDF กำลังโหลด");
                const pdf = new jspdfLib('p', 'mm', 'a4'); const pdfWidth = pdf.internal.pageSize.getWidth();
                $('#pdf-name').text($('#profile-display-name').text()); $('#pdf-age').text($('#profile-display-age').text().replace('อายุ: ', '').replace(' ปี', ''));
                let rt = "ประวัติทั้งหมด"; if (filtMode === 'date') { const p = selectedFilter.split('-'); rt = `${p[2]}-${p[1]}-${p[0]}`; }
                else if (filtMode === 'month') { const p = selectedFilter.split('-'); rt = `${p[1]}-${p[0]}`; }
                $('#pdf-report-type').text(rt); $('#pdf-gen-time').text(new Date().toLocaleString('th-TH'));
                
                const originalMetricState = curMetric; chartInstance.setDatasetVisibility(0, true); chartInstance.setDatasetVisibility(1, true); chartInstance.update('none'); 
                await new Promise(r => setTimeout(r, 250)); const chartCanvas = document.getElementById('chart');
                if (chartCanvas) $('#pdf-chart-img').attr('src', chartCanvas.toDataURL("image/png"));

                const ROWS_FIRST_PAGE = 10, ROWS_SUB_PAGES = 18; 
                const totalPages = Math.ceil((targetData.length > ROWS_FIRST_PAGE) ? 1 + (targetData.length - ROWS_FIRST_PAGE) / ROWS_SUB_PAGES : 1);

                for (let p = 0; p < totalPages; p++) {
                    if (p > 0) pdf.addPage();
                    if (p === 0) { $('#pdf-chart-section').show(); $('#pdf-table-title').text("รายการบันทึกข้อมูลสุขภาพ"); }
                    else { $('#pdf-chart-section').hide(); $('#pdf-table-title').text("รายการบันทึกข้อมูลสุขภาพ (ต่อ)"); }
                    
                    const start = p === 0 ? 0 : ROWS_FIRST_PAGE + (p - 1) * ROWS_SUB_PAGES;
                    const count = (p === 0 ? ROWS_FIRST_PAGE : ROWS_SUB_PAGES);
                    const pageData = targetData.slice(start, start + count);
                    const rowsHtml = pageData.map((i, idx) => `<tr><td style="padding:10px;border:1.5px solid #000;">${start + idx + 1}</td><td style="padding:10px;border:1.5px solid #000;">${i.label}</td><td style="padding:10px;border:1.5px solid #000;">${i.hr}</td><td style="padding:10px;border:1.5px solid #000;">${i.spo2}%</td></tr>`).join('');
                    $('#pdf-table-body').html(rowsHtml);
                    $('#pdf-page-number').text(`หน้า ${p + 1} จาก ${totalPages}`);

                    const element = document.getElementById('pdf-export-template');
                    const canvas = await html2canvas(element, { scale: 2, backgroundColor: "#ffffff" });
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, pdfWidth, (canvas.height * pdfWidth) / canvas.width, undefined, 'FAST');
                }
                pdf.save(`HealthReport_${rt.replace(/-/g, '_')}.pdf`); $('#pdf-chart-img').attr('src', ''); curMetric = originalMetricState; updateChart(); showPopup("สำเร็จ", "รายงานถูกสร้างเรียบร้อยแล้ว");
            } catch (err) { showPopup("ผิดพลาด", err.message, true); } finally { btnReport.prop('disabled', false).html(originalBtnText); }
        };

        window.openEditProfile = () => { if (!profileDataCache) return; $('#edit-firstName').val(profileDataCache.firstName || ''); $('#edit-lastName').val(profileDataCache.lastName || ''); $('#edit-birthDate').val(profileDataCache.birthDate || ''); $('#edit-profile-overlay').removeClass('hidden'); setTimeout(() => $('#edit-profile-modal').removeClass('popup-out').addClass('popup-in'), 10); };
        window.closeEditProfile = () => { $('#edit-profile-modal').removeClass('popup-in').addClass('popup-out'); setTimeout(() => $('#edit-profile-overlay').addClass('hidden'), 300); };
        window.handleSaveProfile = async () => {
            const fName = $('#edit-firstName').val().trim(), lName = $('#edit-lastName').val().trim(), bDate = $('#edit-birthDate').val();
            if (!fName || !lName || !bDate) return alert("กรุณากรอกข้อมูลให้ครบถ้วน");
            $('#btn-save-profile').prop('disabled', true).text('บันทึก...');
            try { await setDoc(doc(db, "users_profiles", currentUser.uid), { firstName: fName, lastName: lName, birthDate: bDate }, { merge: true }); await loadProf(); closeEditProfile(); showPopup("สำเร็จ!", "แก้ไขข้อมูลส่วนตัวเรียบร้อยแล้ว"); }
            catch (e) { showPopup("ล้มเหลว", "บันทึกข้อมูลไม่ได้", true); } finally { $('#btn-save-profile').prop('disabled', false).text('บันทึก'); }
        };

        // Account Security
        window.openChangePassword = () => { $('#change-password-overlay').removeClass('hidden'); setTimeout(() => $('#change-password-modal').removeClass('popup-out').addClass('popup-in'), 10); };
        window.closeChangePassword = () => { $('#change-password-modal').removeClass('popup-in').addClass('popup-out'); setTimeout(() => $('#change-password-overlay').addClass('hidden'), 300); $('#old-password, #new-password, #confirm-new-password').val(''); };
        window.openDeleteAccount = () => { $('#delete-account-overlay').removeClass('hidden'); setTimeout(() => $('#delete-account-modal').removeClass('popup-out').addClass('popup-in'), 10); };
        window.closeDeleteAccount = () => { $('#delete-account-modal').removeClass('popup-in').addClass('popup-out'); setTimeout(() => $('#delete-account-overlay').addClass('hidden'), 300); $('#del-confirm-password').val(''); };

        async function reauth(oldPass) {
            const credential = EmailAuthProvider.credential(currentUser.email, oldPass);
            return reauthenticateWithCredential(currentUser, credential);
        }

        window.handleChangePassword = async () => {
            const op = $('#old-password').val(), np = $('#new-password').val(), cnp = $('#confirm-new-password').val();
            if (!op || !np || !cnp) return showPopup("ผิดพลาด", "กรุณากรอกข้อมูลให้ครบถ้วน", true);
            if (np !== cnp) return showPopup("ผิดพลาด", "รหัสผ่านใหม่ไม่ตรงกัน", true);
            if (np.length < 6) return showPopup("ผิดพลาด", "รหัสผ่านต้องมีความยาวอย่างน้อย 6 ตัวอักษร", true);
            $('#btn-confirm-change-pw').prop('disabled', true).text('กำลังดำเนินการ...');
            try {
                await reauth(op);
                await updatePassword(currentUser, np);
                closeChangePassword();
                showPopup("สำเร็จ!", "เปลี่ยนรหัสผ่านเรียบร้อยแล้ว");
            } catch (e) {
                showPopup("ล้มเหลว", "รหัสผ่านเดิมไม่ถูกต้อง หรือเกิดข้อผิดพลาดในการเชื่อมต่อ", true);
            } finally {
                $('#btn-confirm-change-pw').prop('disabled', false).text('ตกลง');
            }
        };

        window.handleDeleteAccount = async () => {
            const pass = $('#del-confirm-password').val();
            if (!pass) return showPopup("ผิดพลาด", "กรุณากรอกรหัสผ่านเพื่อยืนยัน", true);
            $('#btn-confirm-delete-acc').prop('disabled', true).text('กำลังลบ...');
            try {
                await reauth(pass);
                await deleteDoc(doc(db, "users_profiles", currentUser.uid));
                await deleteUser(currentUser);
                closeDeleteAccount();
                showPopup("ลบบัญชีสำเร็จ", "บัญชีของคุณถูกลบออกจากระบบเรียบร้อยแล้ว");
            } catch (e) {
                showPopup("ล้มเหลว", "รหัสผ่านไม่ถูกต้อง ไม่สามารถลบบัญชีได้", true);
            } finally {
                $('#btn-confirm-delete-acc').prop('disabled', false).text('ยืนยันการลบ');
            }
        };

        // Forgot Password
        window.goToForgotPw = () => {
            $('#auth-screen').fadeOut(200, () => {
                $('#forgot-pw-screen').fadeIn(200).addClass('fade-in');
            });
        };

        window.backToLogin = () => {
            $('#forgot-pw-screen').fadeOut(200, () => {
                $('#auth-screen').fadeIn(200).addClass('fade-in');
                $('#forgot-email').val('');
                $('#forgot-error-msg').addClass('hidden');
            });
        };

        window.executeForgotPassword = async () => {
            const email = $('#forgot-email').val().trim();
            if (!email) return showForgotErr("กรุณาระบุอีเมลผู้ใช้งาน");
            
            $('#forgot-submit-btn').prop('disabled', true).text('กำลังส่งคำขอ...');
            try {
                await sendPasswordResetEmail(auth, email);
                showPopup("ส่งสำเร็จ", `ระบบได้ส่งลิงก์ตั้งรหัสผ่านใหม่ไปยัง ${email} แล้ว โปรดตรวจสอบอีเมลของคุณ (หากไม่พบอีเมลในกล่องขาเข้า กรุณาตรวจสอบในโฟลเดอร์จดหมายขยะ)`);
                backToLogin();
            } catch (err) {
                showForgotErr("ไม่พบอีเมลนี้ในระบบ หรือเกิดข้อผิดพลาดในการส่ง");
            } finally {
                $('#forgot-submit-btn').prop('disabled', false).text('ส่งคำขอรีเซ็ตรหัสผ่าน');
            }
        };

        function showForgotErr(m) { $('#forgot-error-msg').text(m).removeClass('hidden'); }

        onAuthStateChanged(auth, async user => {
            if (user) { 
                currentUser = user; 
                $('#auth-screen, #forgot-pw-screen').hide(); 
                $('#dashboard-screen').show(); 
                $('#user-email-display-profile').text(user.email); 
                await loadProf(); 
                initDash(); 
            }
            else { 
                $('#dashboard-screen').hide();
                if ($('#forgot-pw-screen').is(':hidden')) {
                    $('#auth-screen').show(); 
                }
                stopListeners(); 
            }
        });

        async function loadProf() {
            try {
                const d = await getDoc(doc(db, "users_profiles", currentUser.uid));
                if (d.exists()) { 
                    const data = d.data(); profileDataCache = data; pairedDeviceId = data.pairedDeviceId; $('#device-id-input').val(pairedDeviceId); 
                    const fullName = `${data.firstName || ''} ${data.lastName || ''}`.trim() || 'ผู้ใช้ทั่วไป';
                    $('#profile-display-name').text(fullName); $('#profile-display-age').text(`อายุ: ${calculateAge(data.birthDate)} ปี`);
                    if (data.profileImage) {
                        $('#profile-avatar').attr('src', data.profileImage).removeClass('hidden');
                        $('#profile-placeholder').addClass('hidden');
                    } else {
                        $('#profile-avatar').addClass('hidden');
                        $('#profile-placeholder').removeClass('hidden');
                    }
                }
            } catch(e) {}
        }

        window.toggleAuthMode = () => { 
            isRegisterMode = !isRegisterMode; 
            $('#auth-title').text(isRegisterMode ? 'สมัครสมาชิก' : 'เข้าสู่ระบบ'); 
            $('#auth-submit-btn').text(isRegisterMode ? 'ลงทะเบียน' : 'เข้าสู่ระบบ'); 
            $('#register-only-fields, #register-confirm-field').toggleClass('hidden', !isRegisterMode); 
            $('#auth-toggle-btn').toggleClass('hidden', isRegisterMode); 
            $('#forgot-password-link').toggleClass('hidden', isRegisterMode);
            // Show/Hide back button
            $('#auth-back-btn').toggleClass('hidden', !isRegisterMode);
            // Hide error message when switching modes
            $('#error-msg').addClass('hidden');
            // Update placeholder based on mode
            $('#email').attr('placeholder', isRegisterMode ? 'อีเมล (ระบุอีเมลที่ติดต่อได้จริง)' : 'อีเมล');
        };

        // Function to validate email format using Regex
        const validateEmailFormat = (email) => {
            return String(email)
                .toLowerCase()
                .match(
                    /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
                );
        };
        
        window.handleAuthSubmit = async () => {
            const e = $('#email').val().trim(), p = $('#password').val(), cp = $('#confirm-password').val(), fName = $('#firstName').val().trim(), lName = $('#lastName').val().trim(), bDate = $('#birthDate').val();
            
            if (!e || !p) return showErr("กรุณากรอกข้อมูลให้ครบถ้วน");

            // Check if email format is valid
            if (!validateEmailFormat(e)) {
                return showErr("รูปแบบอีเมลไม่ถูกต้อง กรุณาใช้อีเมลที่มีอยู่จริงเท่านั้น (เช่น example@mail.com)");
            }

            try {
                if (isRegisterMode) { 
                    if (!fName || ! lName || !bDate) return showErr("กรุณากรอกข้อมูลให้ครบถ้วน"); 
                    if (p !== cp) return showErr("รหัสผ่านไม่ตรงกัน"); 
                    const uc = await createUserWithEmailAndPassword(auth, e, p); 
                    await setDoc(doc(db, "users_profiles", uc.user.uid), { firstName: fName, lastName: lName, birthDate: bDate, email: e, pairedDeviceId: "" }); 
                    
                    // Requirement: Show success popup and redirect back to login
                    showPopup("ลงทะเบียนสำเร็จ", "บัญชีของคุณถูกสร้างเรียบร้อยแล้ว กรุณาเข้าสู่ระบบด้วยอีเมลและรหัสผ่านของคุณ");
                    await signOut(auth); // Prevent auto-login by Firebase
                    if (isRegisterMode) toggleAuthMode(); // Reset view to login mode
                    // Clear inputs
                    $('#email, #password, #confirm-password, #firstName, #lastName, #birthDate').val('');
                }
                else await signInWithEmailAndPassword(auth, e, p);
            } catch(err) { 
                if (isRegisterMode) {
                    showErr("อีเมลนี้อาจถูกใช้งานไปแล้ว หรือข้อมูลไม่ถูกต้อง"); 
                } else {
                    showErr("อีเมลหรือรหัสผ่านไม่ถูกต้อง"); 
                }
            }
        };
        
        function showErr(m) { $('#error-msg').text(m).removeClass('hidden'); }
        window.saveDeviceId = async () => { const id = $('#device-id-input').val().trim(); if (!id) return; try { await setDoc(doc(db, "users_profiles", currentUser.uid), { pairedDeviceId: id }, { merge: true }); pairedDeviceId = id; showPopup("เชื่อมต่อสำเร็จ!", `อุปกรณ์เครื่อง ${id} พร้อมใช้งาน`); initDash(); } catch (e) { showPopup("ล้มเหลว", "ผูกเครื่องไม่ได้", true); } };
        window.logout = () => signOut(auth);

        function initDash() { initChart(); stopListeners(); if (pairedDeviceId) { listenDev(); listenHist(); } switchTab(2); }
        function stopListeners() { if(unsubscribeDevice) unsubscribeDevice(); if(unsubscribeHistory) unsubscribeHistory(); }
        
        function listenDev() {
            let isFirstSnapshot = true; 
            const q = query(collection(db, "users", pairedDeviceId, "records"), orderBy("timestamp", "desc"), limit(1));
            unsubscribeDevice = onSnapshot(q, s => { 
                if (s.empty) { resetRealtimeUI(); return; } 
                const d = s.docs[0].data(); 
                if (isFirstSnapshot) { isFirstSnapshot = false; resetRealtimeUI(); return; } 
                updateRealUI(d); 
            });
        }

        function listenHist() {
            const q = query(collection(db, "users", currentUser.uid, "history"), orderBy("timestamp", "asc"));
            unsubscribeHistory = onSnapshot(q, s => {
                allHist = s.docs.map(doc => { const d = doc.data(); const dt = d.timestamp?.seconds ? new Date(d.timestamp.seconds * 1000) : new Date(d.timestamp); return { label: dt.toLocaleString('th-TH', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' }), hr: d.heartRate, spo2: d.spo2, ts: dt.getTime() }; });
                if (allHist.length > 0) $('#last-saved-display').text(allHist[allHist.length-1].label); 
                applyFilt(isFirstDataLoad); isFirstDataLoad = false;
            });
        }

        async function saveHist(d, ts) { 
            await addDoc(collection(db, "users", currentUser.uid, "history"), { heartRate: d.heartRate, spo2: d.spo2, timestamp: ts }); 
        }

        function resetRealtimeUI() { $('#current-hr, #current-spo2').text('--'); $('#hr-status, #spo2-status').text('Wait').attr('class', 'px-3 py-1 rounded-lg bg-white border border-gray-100 text-gray-400 font-bold text-[10px]'); }
        
        function updateRealUI(d) {
            const ts = d.timestamp?.seconds ? new Date(d.timestamp.seconds * 1000) : new Date(d.timestamp || Date.now());
            $('#current-hr').text(d.heartRate || '--'); $('#current-spo2').text(d.spo2 || '--'); const h = d.heartRate || 0, s = d.spo2 || 0;
            $('#hr-status').text(h > 100 ? 'High' : (h > 0 && h < 60 ? 'Low' : 'Normal')).attr('class', `px-3 py-1 rounded-lg bg-white border ${h>100||(h<60&&h>0)?'border-red-200 text-red-600':'border-green-100 text-green-500'} font-bold text-[10px]`);
            $('#spo2-status').text(s > 0 && s < 95 ? 'Low' : 'Normal').attr('class', `px-3 py-1 rounded-lg bg-white border ${s>0&&s < 95?'border-blue-200 text-blue-600':'border-green-100 text-green-500'} font-bold text-[10px]`);
            
            if (isRecording && ts.getTime() !== lastTs) { 
                lastTs = ts.getTime(); 
                saveHist(d, ts); 
            }
        }

        window.resetToAll = () => { $('#date-picker, #month-picker').val(""); filtMode = "all"; selectedFilter = ""; applyFilt(true); };
        function applyFilt(jumpToLatest = false) {
            if (filtMode === "all") filtHist = [...allHist];
            else { filtHist = allHist.filter(i => { const d = new Date(i.ts); const val = filtMode === 'date' ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` : `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; return val === selectedFilter; }); }
            const tp = Math.ceil(filtHist.length / PAGE_SIZE) || 1; if (jumpToLatest) curPage = tp; else if (curPage > tp) curPage = tp; renderTable(); updateChart();
        }
        function renderTable() {
            const ti = filtHist.length; const si = (curPage - 1) * PAGE_SIZE; const pd = filtHist.slice(si, si + PAGE_SIZE);
            $('#data-table-body').html(pd.length ? pd.map((i, idx) => `<tr><td class="py-4 text-gray-400 font-mono text-[10px] font-bold text-center">${si + idx + 1}</td><td class="font-bold text-xs text-center">${i.label}</td><td class="font-black text-gray-800 text-center">${i.hr}</td><td class="font-black text-indigo-600 text-center">${i.spo2}%</td></tr>`).join('') : '<tr><td colspan="4" class="py-10 text-gray-300 italic text-xs text-center font-bold">ไม่มีข้อมูล</td></tr>');
            $('#current-page-num').text(curPage); $('#total-pages-num').text(Math.ceil(ti / PAGE_SIZE) || 1); $('#prev-page').prop('disabled', curPage === 1); $('#next-page').prop('disabled', curPage === Math.ceil(ti / PAGE_SIZE));
        }
        window.setMetricView = (v) => { curMetric = v; $('.metric-tab').removeClass('active'); $(`#tab-${v}`).addClass('active'); updateChart(); };
        function updateChart() {
            if (!chartInstance) return; chartRaw = [...filtHist]; let dd = [...chartRaw]; if (dd.length > 200) { const s = Math.ceil(dd.length / 200); dd = dd.filter((_,i) => i % s === 0); }
            chartInstance.data.labels = dd.map((_, i) => i + 1); chartInstance.data.datasets[0].data = dd.map(i => i.hr); chartInstance.data.datasets[1].data = dd.map(i => i.spo2);
            chartInstance.setDatasetVisibility(0, curMetric === 'both' || curMetric === 'hr'); chartInstance.setDatasetVisibility(1, curMetric === 'both' || curMetric === 'spo2'); chartInstance.update();
        }
        function initChart() {
            const ctx = document.getElementById('chart').getContext('2d'); if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [{ label: 'HR', borderColor: '#ef4444', data: [], tension: 0.35, fill: true, backgroundColor: 'rgba(239, 68, 68, 0.05)', borderWidth: 2, pointRadius: 1.5, pointHitRadius: 10 }, { label: 'SpO2', borderColor: '#4f46e5', data: [], tension: 0.35, fill: true, backgroundColor: 'rgba(79, 70, 229, 0.05)', borderWidth: 2, pointRadius: 1.5, pointHitRadius: 10 }] },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    onClick: (e, elements) => { if (elements.length > 0) { const index = elements[0].index; const data = chartRaw[index]; const parts = data.label.split(' '); $('#detail-count').text('ครั้งที่ ' + (index + 1)); $('#detail-date').text(parts[0]); $('#detail-time').text(parts[1]); $('#detail-hr').text(data.hr); $('#detail-spo2').text(data.spo2 + '%'); $('#point-detail-box').show(); } },
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        y: { min: 40, max: 120, grid: { color: '#f8fafc' } }, 
                        x: { 
                            grid: { display: false }, 
                            ticks: { display: true, font: { size: 9, weight: 'bold' }, maxRotation: 0 },
                            title: { display: true, text: 'ลำดับการวัด (เลขครั้งที่)', font: { size: 10, weight: 'bold', family: 'K2D' }, padding: 4 }
                        } 
                    } 
                } 
            });
        }
        document.getElementById('date-picker').onchange = (e) => { if (!e.target.value) return; filtMode = 'date'; selectedFilter = e.target.value; $('#month-picker').val(''); applyFilt(true); };
        document.getElementById('month-picker').onchange = (e) => { if (!e.target.value) return; filtMode = 'month'; selectedFilter = e.target.value; $('#date-picker').val(''); applyFilt(true); };
        $('#prev-page').click(() => { if (curPage > 1) { curPage--; renderTable(); } }); $('#next-page').click(() => { if (curPage < Math.ceil(filtHist.length / PAGE_SIZE)) { curPage++; renderTable(); } });
        window.switchTab = (id) => { $('#mainpage333').removeClass('center00 left1 right2').addClass(id === 1 ? 'left1' : (id === 2 ? 'center00' : 'right2')); $('.icon-size').removeClass('text-indigo-600').addClass('text-gray-300'); $(`#nav-icon-${id}`).addClass('text-indigo-600'); if (id === 3) setTimeout(() => { chartInstance.update(); applyFilt(isFirstDataLoad); }, 150); };
        
        window.toggleRecording = async () => {
            if (!pairedDeviceId) {
                return showPopup("ผิดพลาด", "กรุณาเชื่อมต่ออุปกรณ์ก่อนเริ่มบันทึก", true);
            }
            const lockRef = doc(db, 'artifacts', 'hrspo-98b0c', 'public', 'data', 'device_locks', pairedDeviceId);
            if (!isRecording) {
                try {
                    const snap = await getDoc(lockRef);
                    if (snap.exists()) {
                        const data = snap.data();
                        if (data.activeUserId && data.activeUserId !== currentUser.uid) {
                            return showPopup("ไม่สามารถบันทึกได้", "อุปกรณ์นี้กำลังถูกบันทึกค่าโดยบัญชีผู้ใช้อื่นอยู่ โปรดรอจนกว่าบัญชีนั้นจะหยุดการบันทึก", true);
                        }
                    }
                    await setDoc(lockRef, { activeUserId: currentUser.uid });
                    isRecording = true;
                } catch (e) {
                    return showPopup("ผิดพลาด", "ไม่สามารถตรวจสอบสถานะอุปกรณ์ได้ โปรดลองอีกครั้ง", true);
                }
            } else {
                try {
                    await setDoc(lockRef, { activeUserId: null });
                    isRecording = false;
                } catch (e) {
                    isRecording = false;
                }
            }
            updateRecUI();
        };

        function updateRecUI() { $('#recording-bar').toggleClass('border-red-500 recording-pulse', isRecording); $('#btn-record').toggleClass('bg-red-500 text-white', isRecording).html(isRecording ? 'หยุดบันทึก' : 'เริ่มบันทึก'); $('#rec-title').text(isRecording ? 'กำลังบันทึกข้อมูล...' : 'โหมดดูอย่างเดียว'); $('#rec-dot').toggleClass('bg-red-200', isRecording).toggleClass('bg-gray-400', !isRecording); }
        $(document).ready(() => { resetRealtimeUI(); });
    </script>
</body>
</html>