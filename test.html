<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vital Signs Realtime Dashboard (Full Version)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Load jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=K2D:wght@400;700&display=swap');
        body { 
            font-family: 'K2D', sans-serif; 
            overflow: hidden; 
            background-color: #f3f4f6;
        }

        .cover3man { width: 100vw; height: calc(100vh - 70px); overflow: hidden; position: relative; }
        .div-mainpage333 { display: flex; width: 300vw; height: 100%; position: absolute; top: 0; left: 0; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .coveruserpage, .coverhomebooking, .covertotalbooking { width: 100vw; height: 100%; flex-shrink: 0; overflow: hidden; }

        /* Animation States */
        .left1 { transform: translateX(0); }
        .center00 { transform: translateX(-100vw); }
        .right2 { transform: translateX(-200vw); }

        .page-content-scroll { height: 100%; overflow-y: auto; padding-bottom: 2rem; }
        .content-wrapper { width: 100%; padding: 1rem; }
        
        .bottom-nav-container { position: fixed; bottom: 0; width: 100%; z-index: 50; height: 70px; display: flex; justify-content: center; }
        .covermenubot { display: flex; justify-content: space-around; align-items: center; height: 100%; width: 100%; background-color: white; box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05); border-top-left-radius: 20px; border-top-right-radius: 20px; }
        .sub-botmenu { cursor: pointer; width: 33.33%; display: flex; justify-content: center; align-items: center; height: 100%; transition: all 0.2s; }
        .icon-size { width: 26px; height: 26px; } 

        .auth-card { background: white; padding: 2.5rem; border-radius: 2.5rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); position: relative; }
        
        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        /* History & Chart Styles */
        .picker-input { border: 1px solid #d1d5db; padding: 0.4rem 0.8rem; border-radius: 0.5rem; font-size: 0.875rem; width: 100%; outline: none; }
        .chart-container { background: white; padding: 1rem; border-radius: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        #point-detail-box { display: none; background: #ffffff; border-left: 6px solid #4f46e5; padding: 1.25rem; margin-top: 1rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .metric-tab { cursor: pointer; padding: 0.6rem; font-size: 0.875rem; border-radius: 0.5rem; transition: all 0.2s; text-align: center; flex: 1; }
        .metric-tab.active { background-color: white; color: #4f46e5; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Modal Animation */
        #custom-popup { transition: all 0.3s ease; }
        .popup-in { transform: scale(1); opacity: 1; }
        .popup-out { transform: scale(0.9); opacity: 0; pointer-events: none; }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">

    <!-- 1. Authentication Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="auth-card w-full max-w-md">
            <!-- Back Button -->
            <button id="back-to-login" onclick="toggleAuthMode()" class="absolute top-6 left-6 text-gray-400 hover:text-indigo-600 hidden transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
            </button>

            <div class="text-center mb-8">
                <div class="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-200">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                </div>
                <h2 id="auth-title" class="text-3xl font-black text-gray-800">เข้าสู่ระบบ</h2>
                <p id="auth-desc" class="text-gray-400 mt-2 font-medium">บันทึกประวัติสุขภาพส่วนตัว</p>
            </div>
            
            <div class="space-y-4">
                <input id="email" type="email" placeholder="อีเมล" class="w-full p-4 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none">
                <input id="password" type="password" placeholder="รหัสผ่าน" class="w-full p-4 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none">
                
                <div id="register-only-fields" class="hidden">
                    <input id="confirm-password" type="password" placeholder="ยืนยันรหัสผ่าน" class="w-full p-4 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>

                <div id="error-msg" class="text-red-500 text-sm text-center hidden font-bold"></div>
                
                <button id="auth-submit-btn" onclick="handleAuthSubmit()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-2xl shadow-xl shadow-indigo-100 transition-all active:scale-95">เข้าสู่ระบบ</button>
                <button id="auth-toggle-btn" onclick="toggleAuthMode()" class="w-full text-gray-400 font-bold py-2 hover:text-indigo-600 transition-all">ยังไม่มีบัญชี? สมัครสมาชิก</button>
            </div>
        </div>
    </div>

    <!-- 2. Dashboard Screen -->
    <div id="dashboard-screen" class="hidden">
        <div class="cover3man">
            <div id="mainpage333" class="div-mainpage333 center00">
                
                <!-- Page 1: Settings -->
                <div id="user-page" class="coveruserpage page-content-scroll">
                    <div class="content-wrapper">
                        <h2 class="text-3xl font-black text-gray-800 mb-8 mt-4 text-center">การตั้งค่า</h2>
                        
                        <div class="bg-white p-6 rounded-3xl shadow-xl mb-6 border-2 border-indigo-100">
                            <h3 class="text-lg font-black text-indigo-700 mb-2">เชื่อมต่อเครื่องตรวจ</h3>
                            <p class="text-xs text-gray-400 mb-4">ระบุ Device ID (เช่น device01)</p>
                            <div class="flex gap-2">
                                <input id="device-id-input" type="text" placeholder="ระบุ Device ID" class="flex-1 p-3 bg-gray-50 rounded-xl font-bold border-none focus:ring-2 focus:ring-indigo-500 outline-none">
                                <button onclick="saveDeviceId()" class="bg-indigo-600 text-white px-6 rounded-xl font-bold hover:bg-indigo-700 transition-all">ผูกเครื่อง</button>
                            </div>
                        </div>

                        <div class="bg-gray-800 p-6 rounded-3xl shadow-xl mb-6 text-white overflow-hidden font-mono text-[10px]">
                            <h3 class="text-indigo-400 uppercase font-black mb-3">Debug Info</h3>
                            <p class="mb-1">Path: <span id="debug-path" class="text-indigo-200">--</span></p>
                            <p>Status: <span id="debug-status" class="text-yellow-500">Waiting...</span></p>
                        </div>

                        <div class="bg-white p-6 rounded-3xl shadow-md flex flex-col items-center">
                            <p id="user-email-display" class="text-sm font-bold text-gray-500 mb-4">--</p>
                            <button onclick="logout()" class="w-full py-3 bg-red-50 text-red-500 font-bold rounded-2xl hover:bg-red-500 hover:text-white transition-all">ออกจากระบบ</button>
                        </div>
                    </div>
                </div>
                
                <!-- Page 2: Realtime -->
                <div id="metrics-page" class="coverhomebooking page-content-scroll">
                    <div class="content-wrapper">
                        <h2 class="text-3xl font-black text-gray-800 mb-2 mt-4 text-center">หน้าหลัก</h2>
                        
                        <!-- Last Recorded Time Display (Account History) -->
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center gap-2 bg-indigo-50 px-4 py-1.5 rounded-full border border-indigo-100 shadow-sm">
                                <svg class="w-3.5 h-3.5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <p class="text-[11px] font-bold text-indigo-600">บันทึกล่าสุด: <span id="last-saved-display">--:--</span></p>
                            </div>
                        </div>
                        
                        <div id="recording-bar" class="bg-white p-4 rounded-3xl shadow-lg mb-6 border-2 border-transparent transition-all">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 id="rec-title" class="text-sm font-black text-gray-800">โหมดดูอย่างเดียว</h3>
                                    <p id="rec-status" class="text-[10px] text-gray-400">กดเพื่อบันทึกเข้าประวัติส่วนตัว</p>
                                </div>
                                <button id="btn-record" onclick="toggleRecording()" class="bg-gray-100 text-gray-600 px-4 py-2 rounded-2xl font-black text-xs flex items-center gap-2">
                                    <span class="w-2 h-2 bg-gray-400 rounded-full" id="rec-dot"></span>
                                    เริ่มบันทึก
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 gap-6">
                            <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border-b-8 border-red-500">
                                <div class="flex justify-between items-center mb-4 text-xs font-black text-gray-400 uppercase">
                                    <span>Heart Rate</span>
                                    <span id="hr-status" class="px-3 py-1 rounded-full bg-gray-100">Wait</span>
                                </div>
                                <div class="flex items-baseline justify-center gap-2">
                                    <span id="current-hr" class="text-8xl font-black text-gray-800 leading-none">--</span>
                                    <span class="text-gray-400 font-bold text-xl uppercase">bpm</span>
                                </div>
                            </div>
                            <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border-b-8 border-blue-500">
                                <div class="flex justify-between items-center mb-4 text-xs font-black text-gray-400 uppercase">
                                    <span>Oxygen SpO₂</span>
                                    <span id="spo2-status" class="px-3 py-1 rounded-full bg-gray-100">Wait</span>
                                </div>
                                <div class="flex items-baseline justify-center gap-2">
                                    <span id="current-spo2" class="text-8xl font-black text-gray-800 leading-none">--</span>
                                    <span class="text-gray-400 font-bold text-xl">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Page 3: History -->
                <div id="history-page" class="covertotalbooking page-content-scroll">
                    <div class="content-wrapper">
                        <h2 class="text-3xl font-black text-gray-800 mb-8 mt-4 text-center">ประวัติ</h2>

                        <div class="bg-white p-6 rounded-3xl shadow-lg mb-8 grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 block mb-1">รายวัน</label>
                                <input type="date" id="date-picker" class="picker-input font-bold text-gray-700">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 block mb-1">รายเดือน</label>
                                <input type="month" id="month-picker" class="picker-input font-bold text-gray-700">
                            </div>
                        </div>

                        <div class="chart-container mb-8">
                            <div class="flex bg-gray-100 p-1 rounded-2xl gap-1 mb-6 text-xs">
                                <div onclick="setMetricView('both')" id="tab-both" class="metric-tab active">ทั้งหมด</div>
                                <div onclick="setMetricView('hr')" id="tab-hr" class="metric-tab">HR</div>
                                <div onclick="setMetricView('spo2')" id="tab-spo2" class="metric-tab">SpO₂</div>
                            </div>
                            <div class="h-[250px]"><canvas id="chart"></canvas></div>
                            <div id="point-detail-box">
                                <div class="flex justify-between items-center">
                                    <div class="flex-1">
                                        <p id="detail-date" class="text-sm text-indigo-800 font-black">--</p>
                                        <p id="detail-time" class="text-[10px] text-gray-400">--</p>
                                    </div>
                                    <div class="flex gap-4 text-center border-l pl-4">
                                        <div><p class="text-[8px] text-red-400 font-bold uppercase">HR</p><p id="detail-hr" class="text-xl font-black">--</p></div>
                                        <div><p class="text-[8px] text-blue-400 font-bold uppercase">SpO2</p><p id="detail-spo2" class="text-xl font-black">--</p></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-3xl shadow-xl">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-black text-gray-800">ตารางประวัติ</h3>
                                <div class="text-[10px] font-bold text-indigo-500 bg-indigo-50 px-3 py-1 rounded-full"><span id="current-page-num">1</span> / <span id="total-pages-num">1</span></div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-center">
                                    <thead class="text-[10px] font-bold text-gray-400 uppercase">
                                        <tr><th class="py-3">วัน/เวลา</th><th>HR</th><th>SpO₂</th></tr>
                                    </thead>
                                    <tbody id="data-table-body" class="divide-y divide-gray-50 text-sm"></tbody>
                                </table>
                            </div>
                            <div class="mt-6 flex justify-between gap-2">
                                <button id="prev-page" class="flex-1 py-3 bg-gray-50 rounded-xl font-bold disabled:opacity-30">ก่อนหน้า</button>
                                <button id="next-page" class="flex-1 py-3 bg-gray-50 rounded-xl font-bold disabled:opacity-30">ถัดไป</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-nav-container">
            <div class="covermenubot">
                <div onclick="switchTab(1)" class="sub-botmenu group">
                    <svg id="nav-icon-1" class="icon-size text-gray-300" fill="currentColor" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </div>
                <div onclick="switchTab(2)" class="sub-botmenu"><div id="nav-icon-center" class="h-14 w-14 rounded-2xl bg-indigo-600 flex items-center justify-center -mt-8 shadow-xl text-white transition-all transform hover:scale-110"><svg class="h-8 w-8" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></div></div>
                <div onclick="switchTab(3)" class="sub-botmenu group"><svg id="nav-icon-3" class="icon-size text-gray-300" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3h-2V1h-2v2H9V1H7v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zm-5-8H9c-.55 0-1 .45-1 1s.45 1 1 1h5c.55 0 1-.45 1-1s-.45-1-1-1z"/></svg></div>
            </div>
        </div>
    </div>

    <!-- Custom Popup Modal -->
    <div id="popup-overlay" class="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center hidden">
        <div id="custom-popup" class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-[90%] max-w-sm text-center popup-out">
            <div id="popup-icon-container" class="w-20 h-20 bg-green-100 rounded-3xl flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h3 id="popup-title" class="text-2xl font-black text-gray-800 mb-2">สำเร็จ!</h3>
            <p id="popup-message" class="text-gray-500 mb-8">ผูกอุปกรณ์เรียบร้อยแล้ว</p>
            <button onclick="closePopup()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-2xl shadow-lg shadow-indigo-100 transition-all">
                ตกลง
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDzTkR7xbg9B6UkknvRXiuamWsBR1zIQ90",
            authDomain: "hrspo-98b0c.firebaseapp.com",
            projectId: "hrspo-98b0c",
            storageBucket: "hrspo-98b0c.appspot.com",
            messagingSenderId: "364239224326",
            appId: "1:364239224326:web:1e66faddd8e6dd2e718d87"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, pairedDeviceId = null, chartInstance = null;
        let unsubscribeDevice = null, unsubscribeHistory = null, isRecording = false, lastTs = 0;
        let isRegisterMode = false, allHist = [], filtHist = [], curPage = 1, curMetric = 'both';
        const PAGE_SIZE = 10;
        let selectedFilter = new Date().toISOString().split('T')[0];
        let filtMode = 'date';
        let chartRaw = [];

        // --- POPUP SYSTEM ---
        window.showPopup = (title, message) => {
            const overlay = $('#popup-overlay');
            const popup = $('#custom-popup');
            $('#popup-title').text(title);
            $('#popup-message').text(message);
            overlay.removeClass('hidden');
            setTimeout(() => popup.removeClass('popup-out').addClass('popup-in'), 10);
        };

        window.closePopup = () => {
            const overlay = $('#popup-overlay');
            const popup = $('#custom-popup');
            popup.removeClass('popup-in').addClass('popup-out');
            setTimeout(() => overlay.addClass('hidden'), 300);
        };

        onAuthStateChanged(auth, async user => {
            if (user) {
                currentUser = user; 
                $('#auth-screen').hide(); 
                $('#dashboard-screen').show(); 
                $('#user-email-display').text(user.email);
                await loadProf(); 
                initDash();
            } else {
                $('#auth-screen').show(); 
                $('#dashboard-screen').hide(); 
                stopListeners();
            }
        });

        async function loadProf() {
            try {
                const d = await getDoc(doc(db, "users_profiles", currentUser.uid));
                if (d.exists()) { 
                    pairedDeviceId = d.data().pairedDeviceId; 
                    $('#device-id-input').val(pairedDeviceId); 
                }
            } catch(e) {}
        }

        window.toggleAuthMode = () => {
            isRegisterMode = !isRegisterMode;
            $('#auth-title').text(isRegisterMode ? 'สมัครสมาชิก' : 'เข้าสู่ระบบ');
            $('#auth-desc').text(isRegisterMode ? 'สร้างบัญชีเพื่อเริ่มบันทึกข้อมูล' : 'บันทึกประวัติสุขภาพส่วนตัว');
            $('#auth-submit-btn').text(isRegisterMode ? 'ลงทะเบียน' : 'เข้าสู่ระบบ');
            $('#register-only-fields').toggleClass('hidden', !isRegisterMode);
            $('#back-to-login').toggleClass('hidden', !isRegisterMode);
            $('#auth-toggle-btn').toggleClass('hidden', isRegisterMode);
            $('#error-msg').addClass('hidden');
        };

        window.handleAuthSubmit = async () => {
            const e = $('#email').val().trim(), p = $('#password').val(), cp = $('#confirm-password').val();
            if (!e || !p) return showErr("กรุณากรอกข้อมูล");
            try {
                if (isRegisterMode) {
                    if (p !== cp) return showErr("รหัสผ่านไม่ตรงกัน");
                    await createUserWithEmailAndPassword(auth, e, p);
                } else await signInWithEmailAndPassword(auth, e, p);
            } catch(err) { showErr("ผิดพลาด: " + err.code); }
        };

        function showErr(m) { $('#error-msg').text(m).removeClass('hidden'); }
        
        window.saveDeviceId = async () => {
            const id = $('#device-id-input').val().trim();
            if (!id) return;
            try {
                await setDoc(doc(db, "users_profiles", currentUser.uid), { pairedDeviceId: id }, { merge: true });
                pairedDeviceId = id;
                showPopup("เชื่อมต่อสำเร็จ!", `ตอนนี้คุณผูกกับเครื่อง ${id} เรียบร้อยแล้ว`);
                initDash();
            } catch (e) { showErr("เกิดข้อผิดพลาดในการบันทึก"); }
        };
        
        window.logout = () => signOut(auth);

        function resetRealtimeUI() {
            $('#current-hr').text('--');
            $('#current-spo2').text('--');
            $('#hr-status').text('Wait').attr('class', 'px-3 py-1 rounded-full bg-gray-100');
            $('#spo2-status').text('Wait').attr('class', 'px-3 py-1 rounded-full bg-gray-100');
        }

        function initDash() {
            resetRealtimeUI(); // เมื่อล็อกอินใหม่ หรือรีเซ็ตบอร์ด ให้เป็นค่าวินิจฉัยเริ่มต้น --
            initChart(); 
            stopListeners();
            if (pairedDeviceId) { 
                listenDev(); 
                listenHist(); 
            }
            switchTab(2);
        }

        function stopListeners() { 
            if(unsubscribeDevice) unsubscribeDevice(); 
            if(unsubscribeHistory) unsubscribeHistory(); 
        }

        function listenDev() {
            const path = `users/${pairedDeviceId}/records`;
            $('#debug-path').text(path);
            let isFirstSnapshot = true; // ตัวแปรสำหรับข้ามข้อมูลเก่าชุดแรก

            const q = query(collection(db, "users", pairedDeviceId, "records"), orderBy("timestamp", "desc"), limit(1));
            unsubscribeDevice = onSnapshot(q, async s => {
                if (s.empty) { 
                    $('#debug-status').text("No Data").attr('class','text-orange-500'); 
                    return; 
                }
                $('#debug-status').text("Online").attr('class','text-green-500');
                const d = s.docs[0].data();
                const ts = d.timestamp?.seconds ? new Date(d.timestamp.seconds * 1000) : new Date(d.timestamp || Date.now());
                $('#debug-last-time').text(ts.toLocaleTimeString());

                // ข้ามการแสดงผลครั้งแรกเพื่อไม่ให้โชว์ค่าวัดล่าสุดที่ค้างอยู่ (จนกว่าบอร์ดจะส่งค่าใหม่มา)
                if (isFirstSnapshot) {
                    isFirstSnapshot = false;
                    console.log("Skipped historical data");
                    return;
                }

                updateRealUI(d);
                if (isRecording && ts.getTime() !== lastTs) { 
                    lastTs = ts.getTime(); 
                    await saveHist(d, ts); 
                }
            });
        }

        function listenHist() {
            const q = query(collection(db, "users", currentUser.uid, "history"), orderBy("timestamp", "desc"));
            unsubscribeHistory = onSnapshot(q, s => {
                allHist = s.docs.map(doc => {
                    const d = doc.data();
                    const dt = d.timestamp?.seconds ? new Date(d.timestamp.seconds * 1000) : new Date(d.timestamp);
                    return {
                        label: dt.toLocaleString('th-TH', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' }),
                        hr: d.heartRate, spo2: d.spo2, ts: dt.getTime()
                    };
                });
                
                // อัปเดตเวลาบันทึกล่าสุด (เฉพาะของบัญชีนี้)
                if (allHist.length > 0) {
                    $('#last-saved-display').text(allHist[0].label);
                } else {
                    $('#last-saved-display').text('ยังไม่มีการบันทึก');
                }
                applyFilt();
            });
        }

        async function saveHist(d, ts) { 
            await addDoc(collection(db, "users", currentUser.uid, "history"), { heartRate: d.heartRate, spo2: d.spo2, timestamp: ts }); 
        }

        function updateRealUI(d) {
            $('#current-hr').text(d.heartRate || '--'); 
            $('#current-spo2').text(d.spo2 || '--');
            const h = d.heartRate || 0, s = d.spo2 || 0;
            $('#hr-status').text(h > 100 ? 'High' : (h > 0 && h < 60 ? 'Low' : 'Normal')).attr('class', `px-3 py-1 rounded-full ${h>100||h<60&&h>0?'bg-red-50 text-red-500':'bg-green-50 text-green-500'}`);
            $('#spo2-status').text(s > 0 && s < 95 ? 'Low' : 'Normal').attr('class', `px-3 py-1 rounded-full ${s>0&&s<95?'bg-red-50 text-red-500':'bg-green-50 text-green-500'}`);
        }

        function applyFilt() {
            filtHist = allHist.filter(i => {
                const d = new Date(i.ts);
                const val = filtMode === 'date' ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` : `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                return val === selectedFilter;
            });
            renderTable(); updateChart();
        }

        function renderTable() {
            const pages = Math.ceil(filtHist.length / PAGE_SIZE) || 1;
            if (curPage > pages) curPage = pages;
            const data = filtHist.slice((curPage - 1) * PAGE_SIZE, curPage * PAGE_SIZE);
            $('#data-table-body').html(data.length ? data.map(i => `<tr><td class="py-4 text-gray-400 font-mono text-[10px]">${i.label}</td><td class="font-black">${i.hr}</td><td class="font-black text-indigo-600">${i.spo2}%</td></tr>`).join('') : '<tr><td colspan="3" class="py-12 text-gray-300 italic text-xs">ไม่มีข้อมูล</td></tr>');
            $('#current-page-num').text(curPage); $('#total-pages-num').text(pages);
            $('#prev-page').prop('disabled', curPage === 1); $('#next-page').prop('disabled', curPage === pages);
        }

        function updateChart() {
            if (!chartInstance) return;
            chartRaw = [...filtHist].sort((a,b) => a.ts - b.ts);
            if (chartRaw.length > 100) { const s = Math.ceil(chartRaw.length / 100); chartRaw = chartRaw.filter((_,i) => i % s === 0); }
            chartInstance.data.labels = chartRaw.map(i => { const d = new Date(i.ts); return filtMode === 'month' ? `${d.getDate()}/${d.getMonth()+1}` : `${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`; });
            chartInstance.data.datasets[0].data = chartRaw.map(i => i.hr); chartInstance.data.datasets[1].data = chartRaw.map(i => i.spo2);
            chartInstance.setDatasetVisibility(0, curMetric !== 'spo2'); chartInstance.setDatasetVisibility(1, curMetric !== 'hr');
            chartInstance.update();
        }

        window.toggleRecording = () => { if (!pairedDeviceId) return alert("ผูกเครื่องก่อน"); isRecording = !isRecording; updateRecUI(); };
        function updateRecUI() {
            $('#recording-bar').toggleClass('border-red-500 recording-pulse', isRecording);
            $('#btn-record').toggleClass('bg-red-500 text-white', isRecording).html(isRecording ? 'หยุดบันทึก' : 'เริ่มบันทึก');
            $('#rec-title').text(isRecording ? 'กำลังบันทึกข้อมูล...' : 'โหมดดูอย่างเดียว');
        }

        window.setMetricView = (v) => { curMetric = v; $('.metric-tab').removeClass('active'); $(`#tab-${v}`).addClass('active'); updateChart(); };
        function initChart() {
            const ctx = document.getElementById('chart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'HR', borderColor: '#ef4444', data: [], tension: 0.4, fill: true, backgroundColor: 'rgba(239, 68, 68, 0.05)', borderWidth: 3, pointRadius: 4 }, { label: 'SpO2', borderColor: '#4f46e5', data: [], tension: 0.4, fill: true, backgroundColor: 'rgba(79, 70, 229, 0.05)', borderWidth: 3, pointRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, onClick: (e, els) => { if (els.length) { const d = chartRaw[els[0].index]; $('#point-detail-box').show(); $('#detail-date').text(d.label.split(',')[0]); $('#detail-time').text(d.label.split(',')[1]); $('#detail-hr').text(d.hr); $('#detail-spo2').text(d.spo2); } }, plugins: { legend: { display: false } }, scales: { y: { min: 40, max: 120 } } }
            });
        }

        document.getElementById('date-picker').onchange = (e) => { filtMode = 'date'; selectedFilter = e.target.value; $('#month-picker').val(''); applyFilt(); };
        document.getElementById('month-picker').onchange = (e) => { filtMode = 'month'; selectedFilter = e.target.value; $('#date-picker').val(''); applyFilt(); };
        $('#prev-page').click(() => { if (curPage > 1) { curPage--; renderTable(); } });
        $('#next-page').click(() => { if (curPage < Math.ceil(filtHist.length / PAGE_SIZE)) { curPage++; renderTable(); } });

        window.switchTab = (id) => {
            $('#mainpage333').removeClass('center00 left1 right2').addClass(id === 1 ? 'left1' : (id === 2 ? 'center00' : 'right2'));
            $('.icon-size').removeClass('text-indigo-600').addClass('text-gray-300'); $(`#nav-icon-${id}`).addClass('text-indigo-600');
            if (id === 3) setTimeout(() => chartInstance.update(), 150);
        };

        $(document).ready(() => { $('#date-picker').val(selectedFilter); });
    </script>
</body>
</html>